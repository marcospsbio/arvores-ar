<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR 츼rvores Viewer 2.0</title>

    <!-- A-Frame (Framework 3D) -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js (Realidade Aumentada para Web) -->
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nst.js'></script>
    <!-- JSZip (Para abrir o KMZ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
        }

        /* UI de Overlay */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8); /* Fundo escuro inicial */
            transition: opacity 0.5s;
        }

        /* Quando a AR come칞a, o fundo fica transparente e painel vai pra baixo */
        body.ar-active #ui-layer {
            background: transparent;
            justify-content: flex-end;
            padding-bottom: 20px;
            pointer-events: none;
        }
        
        body.ar-active .panel {
            pointer-events: auto;
            margin-bottom: 20px;
        }

        /* Painel de Controle */
        .panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .hidden { display: none !important; }

        h1 { margin: 0 0 10px 0; font-size: 20px; color: #2c3e50; }
        p { margin: 0 0 15px 0; font-size: 14px; color: #666; line-height: 1.5; }

        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.98); }

        .btn-blue { background: #2980b9; }
        .btn-red { background: #c0392b; }

        /* Input de arquivo escondido */
        #fileInput { display: none; }

        /* Info de Depura칞칚o no topo */
        #debug-info {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 8px;
            font-family: monospace;
            font-size: 11px;
            z-index: 9998;
            text-align: center;
            pointer-events: none;
        }

        .status-error { color: #ff5252 !important; font-weight: bold; }
        .status-ok { color: #69f0ae !important; }
    </style>
</head>
<body>

    <div id="debug-info">Sistema pronto. Aguardando in칤cio.</div>

    <div id="ui-layer">
        
        <!-- Tela 1: In칤cio / Solicitar Permiss칚o -->
        <div id="start-screen" class="panel">
            <h1>游꺕 Visualizador AR</h1>
            <p>Para ver as 치rvores, precisamos acessar sua <b>C칙mera</b> e <b>GPS</b>.</p>
            <p id="https-warning" class="status-error hidden">丘멆잺 ALERTA: Site n칚o seguro (HTTP). O GPS n칚o funcionar치. Use HTTPS ou Localhost.</p>
            <button class="btn btn-blue" onclick="startApp()">游늸 Permitir GPS e C칙mera</button>
        </div>

        <!-- Tela 2: Carregar Arquivo (aparece depois do GPS ok) -->
        <div id="upload-screen" class="panel hidden">
            <h1>Carregar Mapa</h1>
            <p>GPS Ativo! Agora selecione seu arquivo .KMZ</p>
            
            <button class="btn" onclick="document.getElementById('fileInput').click()">游늭 Selecionar KMZ</button>
            <input type="file" id="fileInput" accept=".kmz,.kml">
            
            <div id="loading-msg" style="display:none; color:#27ae60; margin-top:10px; font-weight:bold;">Processando...</div>
        </div>

        <!-- Controles In-Game -->
        <div id="game-controls" class="panel hidden" style="padding: 15px;">
            <p style="margin:0; font-size:12px;">Aponte para o horizonte.</p>
            <button class="btn btn-secondary" style="font-size:12px; padding:8px; margin-top:5px;" onclick="toggleSimulate()">游 Criar 츼rvore Teste (Aqui)</button>
        </div>
    </div>

    <!-- Cena AR -->
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
    >
        <a-camera 
            id="camera-rig"
            gps-camera="minDistance: 0; maxDistance: 5000; simulateLatitude: 0; simulateLongitude: 0;" 
            rotation-reader
        ></a-camera>

        <a-entity id="tree-container"></a-entity>
    </a-scene>

    <script>
        const debugInfo = document.getElementById('debug-info');
        const treeContainer = document.getElementById('tree-container');
        
        // Verificar HTTPS ao carregar
        if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1')) {
            document.getElementById('https-warning').classList.remove('hidden');
            debugInfo.innerText = "ERRO CR칈TICO: Site n칚o seguro (HTTP).";
            debugInfo.classList.add('status-error');
        }

        // 1. Fun칞칚o chamada pelo bot칚o inicial
        function startApp() {
            debugInfo.innerText = "Solicitando permiss칚o de GPS...";
            
            if (!navigator.geolocation) {
                alert("Seu navegador n칚o suporta Geolocaliza칞칚o.");
                return;
            }

            // For칞a o pedido de permiss칚o explicitamente antes do AR.js tentar
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Sucesso!
                    debugInfo.innerText = `GPS OK! Precis칚o: ${position.coords.accuracy}m`;
                    debugInfo.classList.add('status-ok');
                    
                    // Troca as telas
                    document.getElementById('start-screen').classList.add('hidden');
                    document.getElementById('upload-screen').classList.remove('hidden');
                    
                    // Ativa classe no body para ajustar layout
                    document.body.classList.add('ar-active');
                },
                (error) => {
                    // Erro
                    let msg = "Erro desconhecido.";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: msg = "Permiss칚o negada pelo usu치rio."; break;
                        case error.POSITION_UNAVAILABLE: msg = "Sinal de GPS indispon칤vel."; break;
                        case error.TIMEOUT: msg = "Tempo esgotado ao buscar GPS."; break;
                    }
                    debugInfo.innerText = "ERRO GPS: " + msg;
                    debugInfo.classList.add('status-error');
                    alert("Erro: " + msg + "\nVerifique se a Localiza칞칚o est치 ativa no Android e se o site tem permiss칚o.");
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Listener do Arquivo
        document.getElementById('fileInput').addEventListener('change', async (evt) => {
            const file = evt.target.files[0];
            if (!file) return;

            document.getElementById('loading-msg').style.display = 'block';

            try {
                let kmlText = "";
                if (file.name.toLowerCase().endsWith('.kmz')) {
                    const zip = new JSZip();
                    const zipContent = await zip.loadAsync(file);
                    const kmlFile = Object.keys(zipContent.files).find(n => n.toLowerCase().endsWith('.kml'));
                    if (kmlFile) kmlText = await zipContent.files[kmlFile].async("string");
                } else {
                    const reader = new FileReader();
                    reader.readAsText(file);
                    await new Promise(r => reader.onload = r);
                    kmlText = reader.result;
                }

                parseKML(kmlText);
                
                // Esconde upload e mostra jogo
                document.getElementById('upload-screen').classList.add('hidden');
                document.getElementById('game-controls').classList.remove('hidden');

            } catch (err) {
                alert("Erro ao ler arquivo: " + err.message);
            } finally {
                document.getElementById('loading-msg').style.display = 'none';
            }
        });

        function parseKML(xml) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xml, "text/xml");
            const placemarks = xmlDoc.getElementsByTagName("Placemark");
            let count = 0;

            for (let p of placemarks) {
                const coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                const name = p.getElementsByTagName("name")[0]?.textContent || "츼rvore";
                if (coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    addTree(lat, lon, name);
                    count++;
                }
            }
            alert(`${count} 치rvores carregadas!`);
        }

        function addTree(lat, lon, name) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            el.innerHTML = `
                <a-entity scale="2 2 2" position="0 0 0">
                    <a-text value="${name}" align="center" color="yellow" position="0 4 0" side="double" look-at="[gps-camera]"></a-text>
                    <a-cone color="#2ecc71" position="0 2 0" radius-bottom="1" radius-top="0" height="3"></a-cone>
                    <a-cylinder color="#5d4037" position="0 0.5 0" radius="0.3" height="1"></a-cylinder>
                </a-entity>
            `;
            treeContainer.appendChild(el);
        }

        function toggleSimulate() {
            navigator.geolocation.getCurrentPosition((pos) => {
                addTree(pos.coords.latitude + 0.0002, pos.coords.longitude, "Teste Norte");
                alert("츼rvore criada ao Norte.");
            });
        }

        // Atualizador de Status AR.js
        window.addEventListener('gps-camera-update-position', e => {
            const d = Math.round(e.detail.position.latitude * 1000) / 1000;
            debugInfo.innerText = `GPS Ativo | Lat: ${d}... | 츼rvores: ${treeContainer.children.length}`;
            debugInfo.classList.add('status-ok');
        });
    </script>
</body>
</html>
