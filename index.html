<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Pro Final</title>

    <script>
        // Log simplificado
        window.onerror = function(msg) {
            var logElem = document.getElementById('console-log');
            if (logElem) logElem.innerText = "‚ö†Ô∏è " + msg;
        };
    </script>

    <!-- A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js" crossorigin="anonymous"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js' crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #000; }
        
        #console-log {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.5); color: #0f0; font-size: 11px; 
            pointer-events: none; z-index: 9999; text-align: center; padding: 4px;
        }

        /* --- RADAR --- */
        #radar-container {
            position: fixed; top: 10px; right: 10px; width: 110px; height: 110px;
            background: rgba(0, 20, 0, 0.7); border: 2px solid #0f0; border-radius: 50%;
            z-index: 9990; display: none; overflow: hidden;
            box-shadow: 0 0 10px rgba(0,255,0,0.3);
        }
        #radar-container::before, #radar-container::after {
            content: ''; position: absolute; background: rgba(0, 255, 0, 0.2);
        }
        #radar-container::before { top: 50%; left: 0; width: 100%; height: 1px; }
        #radar-container::after { top: 0; left: 50%; width: 1px; height: 100%; }
        
        #radar-center {
            position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; 
            background: #fff; transform: translate(-50%, -50%); border-radius: 50%; 
            z-index: 2; box-shadow: 0 0 4px white;
        }
        .radar-dot {
            position: absolute; width: 6px; height: 6px; background: yellow; 
            border-radius: 50%; transform: translate(-50%, -50%); transition: all 0.1s;
        }
        .radar-dot.target { 
            background: #ff3333; width: 10px; height: 10px; z-index: 10; 
            border: 2px solid white; box-shadow: 0 0 8px red;
        }

        /* --- HUD --- */
        #nav-card {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px; background: rgba(20, 20, 20, 0.95); 
            padding: 20px; border-radius: 20px; border: 1px solid #444;
            text-align: center; color: white; z-index: 9995; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .btn-stop {
            background: #e74c3c; border: none; color: white; padding: 12px 30px; 
            border-radius: 30px; margin-top: 15px; font-weight: bold; font-size: 14px;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }

        /* --- MENU LISTA --- */
        #menu-btn {
            position: fixed; top: 10px; left: 10px; z-index: 9995;
            background: white; border: none; padding: 12px; border-radius: 10px; 
            font-size: 20px; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #sidebar {
            position: fixed; top: 0; left: -100%; width: 85%; height: 100%;
            background: #f5f6fa; z-index: 9996; transition: 0.3s cubic-bezier(0.4,0,0.2,1); 
            padding: 0; box-sizing: border-box; overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header {
            padding: 20px; background: white; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0;
        }
        .tree-item {
            padding: 20px; border-bottom: 1px solid #e1e1e1; cursor: pointer; background: white;
        }
        .tree-item:active { background: #f0f0f0; }
        .tree-item b { display: block; font-size: 16px; color: #2c3e50; margin-bottom: 4px; }
        .tree-item span { font-size: 13px; color: #7f8c8d; background: #ecf0f1; padding: 4px 8px; border-radius: 12px;}

        /* --- START SCREEN --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a;
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .panel { background: white; padding: 30px; border-radius: 15px; width: 80%; max-width: 400px; text-align: center; }
        .hidden { display: none !important; }

        /* Setas de Borda */
        .edge-arrow {
            position: fixed; width: 50px; height: 50px; 
            background: rgba(255, 0, 0, 0.9); border: 3px solid white;
            color: white; border-radius: 50%; display: none; 
            justify-content: center; align-items: center;
            font-weight: 900; font-size: 24px; z-index: 9990;
            box-shadow: 0 0 15px rgba(255,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="console-log">Aguardando GPS...</div>

    <!-- Radar -->
    <div id="radar-container"><div id="radar-center"></div></div>

    <!-- Menu -->
    <button id="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0;">üìç Locais</h3>
            <button onclick="toggleSidebar()" style="border:none; background:none; font-size:24px;">&times;</button>
        </div>
        <ul id="tree-list" style="list-style: none; padding: 0; margin: 0;"></ul>
    </div>

    <!-- HUD Navega√ß√£o -->
    <div id="nav-card">
        <h2 id="hud-name" style="margin:0; color:#f1c40f; font-size: 20px;">Destino</h2>
        <div id="hud-dist" style="font-size: 42px; font-weight:800; margin: 10px 0;">0m</div>
        <div style="font-size: 13px; color: #bbb;">Siga a dire√ß√£o ou a seta vermelha.</div>
        <button class="btn-stop" onclick="stopNav()">PARAR NAVEGA√á√ÉO</button>
    </div>

    <!-- Setas Direcionais -->
    <div id="arrow-left" class="edge-arrow" style="left: 15px; top: 50%; transform: translateY(-50%);">‚Üê</div>
    <div id="arrow-right" class="edge-arrow" style="right: 15px; top: 50%; transform: translateY(-50%);">‚Üí</div>

    <!-- Tela Inicial -->
    <div id="start-screen">
        <div class="panel" id="p1">
            <h2 style="color:#2c3e50">AR Pro Final</h2>
            <p style="color:#7f8c8d">Localizador com Altitude Autom√°tica.</p>
            <button onclick="startApp()" style="padding:15px; background:#27ae60; color:white; border:none; border-radius:8px; width:100%; font-size:16px; font-weight:bold; cursor:pointer; margin-top:10px;">INICIAR SISTEMA</button>
        </div>
        <div class="panel hidden" id="p2">
            <h3>Carregar Mapa</h3>
            <button onclick="document.getElementById('fileInput').click()" style="padding:12px; background:#3498db; color:white; border:none; border-radius:5px; width:100%; font-weight:bold; margin-bottom:15px;">üìÇ ABRIR ARQUIVO (.KMZ)</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
            
            <div style="border-top:1px solid #eee; margin-top:15px; padding-top:15px;">
                <button onclick="addTestObject()" style="background:none; border:1px solid #bdc3c7; color:#7f8c8d; padding:8px 15px; border-radius:20px; font-size:12px;">+ Criar Ponto de Teste</button>
            </div>
        </div>
    </div>

    <!-- Cena 3D -->
    <div id="scene-wrapper"></div>

    <script>
        const log = msg => document.getElementById('console-log').innerText = msg;
        
        let trees = [];
        let currentTarget = null;
        // Altura Fixa: 0 coloca no mesmo n√≠vel da c√¢mera (n√≠vel dos olhos/celular)
        const FIXED_HEIGHT = 0; 
        let userLat = 0, userLon = 0, userHeading = 0;
        let watchId = null;

        // 1. Inicializa√ß√£o
        async function startApp() {
            try {
                // iOS Permission
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }

                // C√¢mera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop()); 

                // GPS Watch
                if("geolocation" in navigator) {
                    watchId = navigator.geolocation.watchPosition(pos => {
                        userLat = pos.coords.latitude;
                        userLon = pos.coords.longitude;
                        
                        // Primeira vez: Injeta Cena
                        if(document.getElementById('scene-wrapper').innerHTML === "") {
                            injectScene();
                            document.getElementById('p1').classList.add('hidden');
                            document.getElementById('p2').classList.remove('hidden');
                            startLoops();
                        }
                    }, err => {
                        alert("Erro GPS: " + err.message);
                    }, { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
                } else {
                    alert("GPS n√£o suportado.");
                }

                // B√∫ssola
                window.addEventListener('deviceorientation', e => {
                    if(e.webkitCompassHeading) userHeading = e.webkitCompassHeading;
                    else if(e.alpha) userHeading = 360 - e.alpha;
                });

            } catch(e) { alert("Erro: " + e.message); }
        }

        function injectScene() {
            document.getElementById('scene-wrapper').innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
                    renderer="logarithmicDepthBuffer: true; antialias: true;">
                    
                    <!-- C√¢mera GPS -->
                    <a-camera id="cam" gps-camera="minDistance: 0; maxDistance: 20000;" rotation-reader></a-camera>
                    
                    <!-- Container Objetos -->
                    <a-entity id="tree-container"></a-entity>
                </a-scene>
            `;
            log("GPS Ativo. Carregue o arquivo.");
        }

        function startLoops() {
            setInterval(updateDistances, 1000); 
            setInterval(updateVisuals, 100);    
        }

        // 2. Parse Arquivo
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file) return;
            try {
                let kmlText = "";
                if(file.name.toLowerCase().endsWith('.kmz')) {
                    const zip = new JSZip();
                    const content = await zip.loadAsync(file);
                    const kmlName = Object.keys(content.files).find(n => n.toLowerCase().endsWith('.kml'));
                    if(kmlName) kmlText = await content.files[kmlName].async("string");
                } else {
                    kmlText = await file.text();
                }
                if(kmlText) parseKML(kmlText);
            } catch(err) { alert("Erro arquivo: " + err); }
        });

        function parseKML(xml) {
            const doc = new DOMParser().parseFromString(xml, "text/xml");
            trees = [];
            const container = document.getElementById('tree-container');
            container.innerHTML = '';

            let count = 0;
            const placemarks = doc.getElementsByTagName("Placemark");
            
            for(let p of placemarks) {
                let coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                let name = p.getElementsByTagName("name")[0]?.textContent || `Ponto ${count + 1}`;
                
                if(coords) {
                    const parts = coords.split(/\s+/)[0].split(',');
                    const lon = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    // Ignoramos a altitude do KML e usamos 0 relativo
                    createTreeEntity(lat, lon, name, count++);
                }
            }
            finishLoading();
        }

        function addTestObject() {
            const fakeLat = userLat + 0.0001; // ~10m Norte
            const fakeLon = userLon;
            const container = document.getElementById('tree-container');
            if(trees.length === 0) container.innerHTML = '';
            createTreeEntity(fakeLat, fakeLon, "Teste (Norte)", trees.length);
            finishLoading();
            alert("Ponto de teste criado!");
        }

        function createTreeEntity(lat, lon, name, id) {
            const container = document.getElementById('tree-container');
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            
            // ALTURA FIXA (FIXED_HEIGHT = 0)
            // position="0 0 0" significa "no mesmo lugar do GPS"
            // O 'y' sendo 0 ou levemente negativo (-1.6) coloca no ch√£o se o celular estiver na altura dos olhos
            el.innerHTML = `
                <a-entity position="0 ${FIXED_HEIGHT} 0" class="visual-model">
                    <a-text value="${name}\n-- m" align="center" color="yellow" 
                            position="0 5 0" scale="10 10 10" look-at="[gps-camera]"
                            side="double" font="roboto"></a-text>
                    
                    <a-cone color="#2ecc71" position="0 2 0" height="4" radius-bottom="1.5" opacity="0.9"></a-cone>
                    <a-cylinder color="#7f8c8d" position="0 0 0" height="1" radius="0.4"></a-cylinder>
                </a-entity>
            `;
            
            container.appendChild(el);
            
            // Radar Dot
            const dot = document.createElement('div');
            dot.className = 'radar-dot';
            document.getElementById('radar-container').appendChild(dot);

            trees.push({ id, name, lat, lon, el, dist: 0, radarDot: dot });
        }

        function finishLoading() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('menu-btn').style.display = 'block';
            document.getElementById('radar-container').style.display = 'block';
            updateList();
        }

        // 3. UI e Navega√ß√£o
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        function updateList() {
            const list = document.getElementById('tree-list');
            list.innerHTML = '';
            // Ordena por proximidade
            trees.sort((a,b) => a.dist - b.dist).forEach(t => {
                const li = document.createElement('li');
                li.className = 'tree-item';
                li.innerHTML = `<b>${t.name}</b> <span id="list-dist-${t.id}">Calc...</span>`;
                li.onclick = () => selectTarget(t.id);
                list.appendChild(li);
            });
        }

        function selectTarget(id) {
            if(currentTarget) {
                currentTarget.el.querySelector('a-cone').setAttribute('color', '#2ecc71');
                currentTarget.radarDot.classList.remove('target');
            }
            currentTarget = trees.find(t => t.id === id);
            currentTarget.el.querySelector('a-cone').setAttribute('color', '#e74c3c'); // Vermelho
            currentTarget.radarDot.classList.add('target');
            
            document.getElementById('nav-card').style.display = 'block';
            document.getElementById('hud-name').innerText = currentTarget.name;
            document.getElementById('sidebar').classList.remove('open');
        }

        function stopNav() {
            if(currentTarget) {
                currentTarget.el.querySelector('a-cone').setAttribute('color', '#2ecc71');
                currentTarget.radarDot.classList.remove('target');
            }
            currentTarget = null;
            document.getElementById('nav-card').style.display = 'none';
            document.getElementById('arrow-left').style.display = 'none';
            document.getElementById('arrow-right').style.display = 'none';
        }

        // 4. Matem√°tica e Loops
        function updateDistances() {
            if(!userLat || !userLon) return;
            trees.forEach(t => {
                t.dist = haversine(userLat, userLon, t.lat, t.lon);
                
                // Texto 3D
                const textEl = t.el.querySelector('a-text');
                if(textEl) textEl.setAttribute('value', `${t.name}\n${t.dist.toFixed(0)}m`);

                // Texto Lista
                const listSpan = document.getElementById(`list-dist-${t.id}`);
                if(listSpan) listSpan.innerText = t.dist.toFixed(0) + "m";

                // Escala e Visibilidade
                const model = t.el.querySelector('.visual-model');
                if(model) {
                    // L√≥gica de escala para n√£o ficar min√∫sculo longe
                    let scale = Math.max(3, t.dist / 10);
                    model.setAttribute('scale', `${scale} ${scale} ${scale}`);
                }
                t.el.setAttribute('visible', t.dist < 10000);
            });

            if(currentTarget) document.getElementById('hud-dist').innerText = currentTarget.dist.toFixed(0) + "m";
        }

        function updateVisuals() {
            if(!userLat || !userLon) return;
            
            const arrL = document.getElementById('arrow-left');
            const arrR = document.getElementById('arrow-right');
            arrL.style.display = 'none';
            arrR.style.display = 'none';

            trees.forEach(t => {
                if(!t.radarDot) return;
                
                // Radar
                const bearing = computeBearing(userLat, userLon, t.lat, t.lon);
                let relAngle = bearing - userHeading;
                // Normaliza -180 a 180
                while(relAngle < -180) relAngle += 360;
                while(relAngle > 180) relAngle -= 360;

                // Raio fixo para dire√ß√£o clara (40%)
                const r = 40; 
                const rad = relAngle * (Math.PI / 180);
                const x = 50 + (r * Math.sin(rad)); 
                const y = 50 - (r * Math.cos(rad)); // -cos pq topo √© 0

                t.radarDot.style.left = x + '%';
                t.radarDot.style.top = y + '%';
                t.radarDot.style.display = (t === currentTarget || t.dist < 200) ? 'block' : 'none';

                // Setas (S√≥ alvo)
                if(currentTarget && t.id === currentTarget.id) {
                    if(relAngle > 35) arrR.style.display = 'flex';
                    else if(relAngle < -35) arrL.style.display = 'flex';
                }
            });
        }

        // Helpers Matem√°ticos
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function computeBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(destLng*Math.PI/180 - startLng*Math.PI/180) * Math.cos(destLat*Math.PI/180);
            const x = Math.cos(startLat*Math.PI/180)*Math.sin(destLat*Math.PI/180) - Math.sin(startLat*Math.PI/180)*Math.cos(destLat*Math.PI/180)*Math.cos(destLng*Math.PI/180 - startLng*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
