<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Campo - Vis√£o Raio-X</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        
        /* Radar no Topo Direito */
        #radar-container {
            position: fixed; top: 15px; right: 15px; width: 100px; height: 100px;
            background: rgba(0, 20, 0, 0.8); border: 2px solid #0f0; border-radius: 50%;
            z-index: 9990; display: none;
        }
        #radar-center {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: white; transform: translate(-50%,-50%);
        }
        .radar-dot {
            position: absolute; width: 8px; height: 8px; background: yellow; border-radius: 50%; transform: translate(-50%,-50%);
        }
        .radar-dot.target { background: red; width: 12px; height: 12px; border: 2px solid white; z-index: 10; }

        /* HUD Inferior */
        #hud {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(0,0,0,0.8); padding: 15px;
            border-radius: 15px; text-align: center; color: white; display: none; z-index: 9995;
            border: 1px solid #444;
        }
        .btn-action {
            background: #e74c3c; color: white; padding: 10px 30px; border: none; 
            border-radius: 30px; font-weight: bold; margin-top: 10px; font-size: 16px;
        }

        /* Menu */
        #menu-btn {
            position: fixed; top: 15px; left: 15px; z-index: 9995; background: white;
            border: none; padding: 10px; border-radius: 5px; font-weight: bold; display: none;
        }
        #list-panel {
            position: fixed; top: 0; left: -100%; width: 100%; height: 100%;
            background: white; z-index: 9998; transition: 0.3s; padding: 20px; box-sizing: border-box;
        }
        #list-panel.open { left: 0; }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; font-size: 18px; }

        /* Tela Inicial */
        #start {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111;
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .card { background: #222; padding: 20px; border-radius: 10px; width: 80%; text-align: center; }
    </style>
</head>
<body>

    <!-- Radar -->
    <div id="radar-container"><div id="radar-center"></div></div>

    <!-- Menu -->
    <button id="menu-btn" onclick="toggleList()">üìÇ LISTA</button>
    <div id="list-panel">
        <h2 style="margin-top:0">Destinos <button onclick="toggleList()" style="float:right">X</button></h2>
        <div id="items-container"></div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <h2 id="hud-name" style="margin:0; color: yellow">Alvo</h2>
        <h1 id="hud-dist" style="margin: 5px 0; font-size: 40px;">0m</h1>
        <p style="margin:0; color:#ccc; font-size:12px">Siga a SETA LARANJA no ch√£o</p>
        <button class="btn-action" onclick="stopNav()">PARAR</button>
    </div>

    <!-- Start Screen -->
    <div id="start">
        <div class="card" id="p1">
            <h2>AR Raio-X</h2>
            <p>Localizador com Seta Direcional</p>
            <button onclick="init()" style="padding:15px; width:100%; background:green; color:white; border:none; font-weight:bold; border-radius:5px;">INICIAR</button>
        </div>
        <div class="card" id="p2" style="display:none">
            <h3>Carregar</h3>
            <input type="file" id="fileInput" accept=".kmz,.kml"><br><br>
            <button onclick="addTest()" style="padding:10px; width:100%; background:blue; color:white; border:none; border-radius:5px;">+ Teste (10m Norte)</button>
        </div>
    </div>

    <!-- Cena A-Frame -->
    <div id="scene-container"></div>

    <script>
        let trees = [];
        let currentTarget = null;
        let userLat=0, userLon=0, userHeading=0;

        // 1. INICIAR
        async function init() {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());

                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;

                    if(!document.querySelector('a-scene')) {
                        injectScene();
                        document.getElementById('p1').style.display = 'none';
                        document.getElementById('p2').style.display = 'block';
                        startLoops();
                    }
                }, err => alert(err.message), { enableHighAccuracy: true });

                window.addEventListener('deviceorientation', e => {
                    userHeading = e.webkitCompassHeading || (360 - e.alpha) || 0;
                });

            } catch(e) { alert(e); }
        }

        function injectScene() {
            document.getElementById('scene-container').innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true">
                    
                    <a-camera id="cam" gps-camera="minDistance: 0; maxDistance: 5000;" rotation-reader>
                        <!-- SETA 3D GRUDADA NA C√ÇMERA (HUD 3D) -->
                        <!-- Ela fica no "ch√£o" da tela (y=-1) e aponta para o alvo -->
                        <a-entity id="guide-arrow" visible="false" position="0 -0.5 -1.5" rotation="-20 0 0">
                            <a-cone color="orange" radius-bottom="0.1" radius-top="0.01" height="0.5" rotation="90 0 0" position="0 0 -0.2"></a-cone>
                            <a-cylinder color="orange" height="0.5" radius="0.03" rotation="90 0 0" position="0 0 0.3"></a-cylinder>
                            <a-text value="VIRE AQUI" align="center" position="0 0.3 0" color="yellow" scale="0.5 0.5 0.5"></a-text>
                        </a-entity>
                    </a-camera>

                    <a-entity id="world"></a-entity>
                </a-scene>
            `;
        }

        // 2. CARREGAR KMZ
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file) return;
            let txt = "";
            if(file.name.toLowerCase().endsWith('.kmz')) {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.endsWith('.kml'));
                if(kmlName) txt = await content.files[kmlName].async("string");
            } else { txt = await file.text(); }
            if(txt) parseKML(txt);
        });

        function parseKML(xml) {
            const doc = new DOMParser().parseFromString(xml, "text/xml");
            const world = document.getElementById('world');
            world.innerHTML = '';
            trees = [];
            let i = 0;
            
            for(let p of doc.getElementsByTagName("Placemark")) {
                let coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                let name = p.getElementsByTagName("name")[0]?.textContent || `Ponto ${i}`;
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    createEntity(lat, lon, name, i++);
                }
            }
            finishLoad();
        }

        function addTest() {
            // Cria ponto bem perto (0.0001 grau ~ 11 metros)
            createEntity(userLat + 0.0001, userLon, "TESTE FRENTE", 999);
            finishLoad();
        }

        function createEntity(lat, lon, name, id) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            
            // MODELO VISUAL
            // depthTest: false -> Faz aparecer atrav√©s de paredes
            // position="0 0 0" -> Tenta ficar no n√≠vel do olho
            el.innerHTML = `
                <a-entity position="0 0 0" class="visual">
                    <a-text value="${name}" align="center" color="yellow" position="0 3 0" scale="8 8 8" look-at="[gps-camera]" z-offset="1"></a-text>
                    
                    <!-- Marcador Vis√≠vel Atraves de Paredes -->
                    <a-cylinder color="red" height="30" radius="0.2" position="0 0 0" material="opacity: 0.6; depthTest: false;"></a-cylinder>
                    <a-cone color="red" height="3" radius-bottom="1" position="0 2 0" material="depthTest: false;"></a-cone>
                    
                    <!-- Linha Vertical para ajudar a achar a altura -->
                    <a-cylinder color="white" height="100" radius="0.05" position="0 -50 0" material="opacity: 0.3"></a-cylinder>
                </a-entity>
            `;
            document.getElementById('world').appendChild(el);

            const dot = document.createElement('div');
            dot.className = 'radar-dot';
            document.getElementById('radar-container').appendChild(dot);

            trees.push({ id, name, lat, lon, el, dot, dist: 0 });
        }

        function finishLoad() {
            document.getElementById('start').style.display = 'none';
            document.getElementById('menu-btn').style.display = 'block';
            document.getElementById('radar-container').style.display = 'block';
            updateList();
        }

        // 3. NAVEGA√á√ÉO E LOOPS
        function toggleList() { document.getElementById('list-panel').classList.toggle('open'); }

        function updateList() {
            const div = document.getElementById('items-container');
            div.innerHTML = '';
            trees.sort((a,b) => a.dist - b.dist).forEach(t => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<b>${t.name}</b> (${t.dist.toFixed(0)}m)`;
                d.onclick = () => selectTarget(t.id);
                div.appendChild(d);
            });
        }

        function selectTarget(id) {
            if(currentTarget) currentTarget.dot.classList.remove('target');
            currentTarget = trees.find(t => t.id === id);
            currentTarget.dot.classList.add('target');
            
            document.getElementById('hud').style.display = 'block';
            document.getElementById('hud-name').innerText = currentTarget.name;
            document.getElementById('guide-arrow').setAttribute('visible', 'true');
            toggleList(); // Fecha menu
        }

        function stopNav() {
            if(currentTarget) currentTarget.dot.classList.remove('target');
            currentTarget = null;
            document.getElementById('hud').style.display = 'none';
            document.getElementById('guide-arrow').setAttribute('visible', 'false');
        }

        function startLoops() {
            setInterval(() => {
                if(!userLat) return;
                trees.forEach(t => {
                    // Dist√¢ncia
                    t.dist = haversine(userLat, userLon, t.lat, t.lon);
                    
                    // Texto
                    const txt = t.el.querySelector('a-text');
                    if(txt) txt.setAttribute('value', `${t.name}\n${t.dist.toFixed(0)}m`);

                    // Escala (Fica grande longe, normal perto)
                    const scale = Math.max(1, t.dist / 10);
                    const vis = t.el.querySelector('.visual');
                    if(vis) vis.setAttribute('scale', `${scale} ${scale} ${scale}`);
                });
                if(currentTarget) document.getElementById('hud-dist').innerText = currentTarget.dist.toFixed(0) + "m";
            }, 500);

            setInterval(() => {
                if(!userLat) return;
                trees.forEach(t => {
                    // Radar
                    const bearing = getBearing(userLat, userLon, t.lat, t.lon);
                    let angle = bearing - userHeading;
                    while(angle < -180) angle += 360;
                    while(angle > 180) angle -= 360;

                    const r = 40;
                    const rad = angle * (Math.PI / 180);
                    t.dot.style.left = (50 + r * Math.sin(rad)) + '%';
                    t.dot.style.top = (50 - r * Math.cos(rad)) + '%';

                    // SETA DIRECIONAL (S√≥ para o alvo atual)
                    if(currentTarget && t.id === currentTarget.id) {
                        // angle = 0 (frente). Se angle for 90 (direita), giramos a seta.
                        // A seta est√° na c√¢mera. Rodar Z da seta gira ela como um rel√≥gio na tela.
                        const arrow = document.getElementById('guide-arrow');
                        // Negativo porque em 3D a rota√ß√£o Z anti-hor√°ria √© positiva
                        arrow.setAttribute('rotation', `-20 0 ${-angle}`); 
                    }
                });
            }, 50);
        }

        // Matem√°tica
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(destLng*Math.PI/180 - startLng*Math.PI/180) * Math.cos(destLat*Math.PI/180);
            const x = Math.cos(startLat*Math.PI/180)*Math.sin(destLat*Math.PI/180) - Math.sin(startLat*Math.PI/180)*Math.cos(destLat*Math.PI/180)*Math.cos(destLng*Math.PI/180 - startLng*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
