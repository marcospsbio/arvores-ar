<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR √Årvores Viewer 3.1 (Fix Script)</title>

    <!-- Configura√ß√£o de Erros Global (Para pegar erros de script externos) -->
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            var string = msg.toLowerCase();
            var substring = "script error";
            var message = "";
            if (string.indexOf(substring) > -1){
                message = 'Script Error: Verifique conex√£o ou permiss√µes (CORS).';
            } else {
                message = msg;
            }
            
            // Tenta exibir na div de log se ela existir, sen√£o alerta
            var logElem = document.getElementById('console-log');
            if (logElem) {
                logElem.innerText = "ERRO CR√çTICO: " + message;
                logElem.classList.add('error-log');
            } else {
                console.error(message);
            }
            return false;
        };
    </script>

    <!-- A-Frame 1.3.0 -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js" crossorigin="anonymous"></script>
    <!-- AR.js Standard -->
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js' crossorigin="anonymous"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: sans-serif;
            background-color: #222; /* Fundo escuro inicial */
        }

        /* UI de Overlay */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.85);
            transition: opacity 0.3s;
            pointer-events: auto;
        }

        /* Modo AR Ativo */
        body.ar-active #ui-layer {
            background: transparent;
            justify-content: flex-end;
            padding-bottom: 30px;
            pointer-events: none;
        }
        
        body.ar-active .panel {
            pointer-events: auto;
        }

        /* Painel central */
        .panel {
            background: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hidden { display: none !important; }

        h2 { margin-top: 0; color: #2c3e50; }

        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        
        /* Console de Log */
        #console-log {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 11px;
            padding: 8px;
            pointer-events: none;
            z-index: 10000;
            max-height: 120px;
            overflow-y: auto;
            white-space: pre-wrap;
            box-sizing: border-box;
        }
        .error-log { color: #ff4444 !important; font-weight: bold; background: rgba(50,0,0,0.9) !important; }

        /* Container onde a cena ser√° injetada */
        #ar-scene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
    </style>
</head>
<body>

    <!-- Log no Topo -->
    <div id="console-log">Sistema pronto. Toque em INICIAR.</div>

    <!-- Interface (Camada Superior) -->
    <div id="ui-layer">
        
        <!-- Passo 1: Permiss√µes -->
        <div id="step-1" class="panel">
            <h2>üå≤ AR √Årvores</h2>
            <p>Para evitar erros, precisamos ativar C√¢mera e GPS manualmente.</p>
            <button onclick="initPermissions()">INICIAR SISTEMA</button>
        </div>

        <!-- Passo 2: Upload -->
        <div id="step-2" class="panel hidden">
            <h3>Carregar Mapa</h3>
            <p>Permiss√µes OK! Selecione o arquivo.</p>
            <button onclick="document.getElementById('fileInput').click()">üìÇ Abrir KMZ</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
        </div>

        <!-- Passo 3: Controles -->
        <div id="step-3" class="panel hidden">
            <p style="margin:0; font-size:12px; color:#333">Aponte para o horizonte.</p>
            <button style="background:#34495e; margin-top:5px; font-size:12px" onclick="addTestTree()">üå≤ Teste (Criar aqui)</button>
        </div>
    </div>

    <!-- Container Vazio para a Cena (A cena ser√° injetada aqui via JS) -->
    <div id="ar-scene-container"></div>

    <script>
        // Fun√ß√£o de Log
        function log(msg, isError = false) {
            const el = document.getElementById('console-log');
            // Adiciona nova linha sem apagar anterior (log hist√≥rico)
            // el.innerText = msg; 
            // Melhor: Apenas a √∫ltima mensagem importante ou append se for debug
            el.innerText = msg; 
            
            if(isError) el.classList.add('error-log');
            else el.classList.remove('error-log');
            console.log(msg);
        }

        // Vari√°vel para guardar as √°rvores temporariamente at√© a cena existir
        let pendingTrees = [];

        // 1. Solicitar Permiss√µes
        async function initPermissions() {
            log("Solicitando acesso...");
            
            try {
                // Pede C√¢mera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(track => track.stop()); // Para o stream para o AR.js assumir
                
                log("C√¢mera OK. Buscando GPS...");

                // Pede GPS
                if (!navigator.geolocation) throw new Error("GPS n√£o suportado.");
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        log(`GPS OK! Precis√£o: ${Math.round(pos.coords.accuracy)}m`);
                        
                        // SUCESSO: Agora sim carregamos a cena AR
                        injectARScene();

                        // Atualiza UI
                        document.getElementById('step-1').classList.add('hidden');
                        document.getElementById('step-2').classList.remove('hidden');
                        document.body.classList.add('ar-active');
                    },
                    (err) => {
                        handleGPSError(err);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );

            } catch (err) {
                log("ERRO PERMISS√ÉO: " + err.name, true);
                alert("Erro: " + err.name + "\nVerifique permiss√µes do navegador.");
            }
        }

        function handleGPSError(err) {
            let erroMsg = "Erro GPS: ";
            if(err.code === 1) erroMsg += "Negado pelo usu√°rio.";
            else if(err.code === 2) erroMsg += "Sinal indispon√≠vel.";
            else if(err.code === 3) erroMsg += "Tempo esgotado.";
            log(erroMsg, true);
        }

        // INJE√á√ÉO DIN√ÇMICA DA CENA
        // Isso evita que o AR.js tente rodar antes das permiss√µes existirem
        function injectARScene() {
            const container = document.getElementById('ar-scene-container');
            container.innerHTML = `
                <a-scene
                    embedded
                    vr-mode-ui="enabled: false"
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                    renderer="logarithmicDepthBuffer: true; alpha: true;"
                >
                    <a-camera 
                        id="camera"
                        gps-camera="minDistance: 0; maxDistance: 5000;" 
                        rotation-reader
                    ></a-camera>
                    
                    <a-entity id="tree-container"></a-entity>
                </a-scene>
            `;
            
            log("Sistema AR Inicializado.");
            
            // Monitorar GPS da C√¢mera para Log
            // Pequeno delay para esperar o elemento existir no DOM
            setTimeout(() => {
                const cam = document.querySelector('[gps-camera]');
                if(cam) {
                    cam.addEventListener('gps-camera-update-position', e => {
                        if(!document.getElementById('console-log').classList.contains('error-log')) {
                            const lat = e.detail.position.latitude.toFixed(5);
                            const lon = e.detail.position.longitude.toFixed(5);
                            const arvores = document.getElementById('tree-container')?.children.length || 0;
                            log(`GPS: ${lat}, ${lon} | √Årvores: ${arvores}`);
                        }
                    });
                }
            }, 1000);
        }

        // 2. Carregar Arquivo
        document.getElementById('fileInput').addEventListener('change', async (evt) => {
            const file = evt.target.files[0];
            if (!file) return;

            log("Processando arquivo...");
            try {
                let kmlText = "";
                if (file.name.toLowerCase().endsWith('.kmz')) {
                    const zip = new JSZip();
                    const zipContent = await zip.loadAsync(file);
                    const kmlFile = Object.keys(zipContent.files).find(n => n.toLowerCase().endsWith('.kml'));
                    if (kmlFile) kmlText = await zipContent.files[kmlFile].async("string");
                    else throw new Error("KMZ sem KML.");
                } else {
                    const reader = new FileReader();
                    reader.readAsText(file);
                    await new Promise(r => reader.onload = r);
                    kmlText = reader.result;
                }

                processKML(kmlText);
                
                document.getElementById('step-2').classList.add('hidden');
                document.getElementById('step-3').classList.remove('hidden');
                
            } catch (err) {
                log("Erro Arquivo: " + err.message, true);
            }
        });

        function processKML(xml) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xml, "text/xml");
            const placemarks = xmlDoc.getElementsByTagName("Placemark");
            
            // Espera container estar pronto
            const container = document.getElementById('tree-container');
            if(!container) {
                log("Erro: Cena AR n√£o pronta.", true);
                return;
            }

            let count = 0;
            for (let p of placemarks) {
                const coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                const name = p.getElementsByTagName("name")[0]?.textContent || "√Årvore";
                
                if (coords) {
                    const parts = coords.split(',');
                    const lon = parseFloat(parts[0]);
                    const lat = parseFloat(parts[1]);
                    createEntity(lat, lon, name, container);
                    count++;
                }
            }
            log(`${count} √°rvores carregadas!`);
        }

        function createEntity(lat, lon, name, parent) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            el.setAttribute('scale', '2 2 2'); // Escala base
            
            // Layout visual da √°rvore
            el.innerHTML = `
                <a-text value="${name}" align="center" color="#f1c40f" position="0 4 0" side="double" look-at="[gps-camera]" scale="2 2 2"></a-text>
                <a-cone color="#2ecc71" position="0 2 0" radius-bottom="1" radius-top="0" height="3"></a-cone>
                <a-cylinder color="#5d4037" position="0 0.5 0" radius="0.3" height="1"></a-cylinder>
            `;
            parent.appendChild(el);
        }

        function addTestTree() {
            navigator.geolocation.getCurrentPosition((pos) => {
                const container = document.getElementById('tree-container');
                if(container) {
                    const lat = pos.coords.latitude + 0.0002; // ~20m Norte
                    const lon = pos.coords.longitude;
                    
                    const el = document.createElement('a-entity');
                    el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
                    el.innerHTML = `
                        <a-text value="TESTE" align="center" color="red" position="0 4 0" side="double" look-at="[gps-camera]"></a-text>
                        <a-box color="red" position="0 2 0" scale="2 2 2"></a-box>
                    `;
                    container.appendChild(el);
                    log("√Årvore Teste criada ao Norte.");
                }
            });
        }
    </script>
</body>
</html>
