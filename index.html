<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR R√°pido - Campo</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Look-at removido para evitar bugs de rota√ß√£o, usando geometria fixa -->

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }

        /* --- SETA DE DIRE√á√ÉO (Que voc√™ gostou) --- */
        #guide-ui {
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            text-align: center; z-index: 9000; pointer-events: none; display: none;
        }
        #arrow-icon {
            font-size: 80px; color: gold; text-shadow: 0 0 10px #000; display: block;
        }
        #guide-text {
            background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; 
            border-radius: 8px; font-weight: bold; margin-top: 5px;
        }

        /* --- HUD INFERIOR --- */
        #hud {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(0,0,0,0.8); 
            padding: 15px; border-radius: 15px; text-align: center; color: white; 
            z-index: 9995; display: none; border: 2px solid gold;
        }
        .dist-text { font-size: 45px; font-weight: 900; margin: 0; }
        .btn-stop {
            background: red; color: white; padding: 10px 30px; border: none; 
            border-radius: 50px; font-weight: bold; margin-top: 10px; cursor: pointer;
        }

        /* --- LISTA --- */
        #menu-btn { position: fixed; top: 15px; left: 15px; z-index: 9995; padding: 10px; background: white; border:none; border-radius:5px; display:none; font-weight:bold; }
        #list-panel { position: fixed; top: 0; left: -100%; width: 100%; height: 100%; background: #f0f0f0; z-index: 9998; transition: 0.3s; overflow-y: auto; }
        #list-panel.open { left: 0; }
        .item { padding: 20px; background: white; border-bottom: 1px solid #ccc; font-size: 16px; }

        /* --- IN√çCIO --- */
        #start { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { background: white; padding: 20px; border-radius: 10px; width: 80%; text-align: center; }
    </style>
</head>
<body>

    <!-- UI VISUAL -->
    <div id="guide-ui">
        <div id="arrow-icon">‚¨Ü</div>
        <div id="guide-text">EM FRENTE</div>
    </div>

    <div id="hud">
        <h3 id="target-name" style="margin:0; color:yellow">Nome</h3>
        <div class="dist-text" id="dist-val">0m</div>
        <button class="btn-stop" onclick="stopNav()">PARAR</button>
    </div>

    <button id="menu-btn" onclick="toggleList()">üìÇ LISTA</button>
    <div id="list-panel">
        <div style="padding:15px; background:#ddd; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">Pontos</h2> <button onclick="toggleList()" style="padding:5px 10px">X</button>
        </div>
        <div id="list-content"></div>
    </div>

    <div id="start">
        <div class="card" id="p1">
            <h2>Localizador R√°pido</h2>
            <p>Visualiza√ß√£o "Pilar de Luz" (Ignora Altitude)</p>
            <button onclick="init()" style="padding:15px; width:100%; background:green; color:white; border:none; font-weight:bold; border-radius:5px;">INICIAR</button>
        </div>
        <div class="card" id="p2" style="display:none">
            <button onclick="document.getElementById('fileInput').click()" style="padding:15px; width:100%; background:blue; color:white; border:none; font-weight:bold; border-radius:5px;">üìÇ CARREGAR KMZ</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
            <br><br>
            <button onclick="addTest()" style="padding:10px; width:100%;">+ Teste (20m Norte)</button>
        </div>
    </div>

    <!-- CENA 3D -->
    <div id="scene-wrapper"></div>

    <script>
        let targets = [];
        let activeTarget = null;
        let userLat=0, userLon=0, userHeading=0;

        // INICIALIZA√á√ÉO
        async function init() {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());

                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;

                    if(!document.getElementById('scene-wrapper').innerHTML) {
                        injectScene();
                        document.getElementById('p1').style.display = 'none';
                        document.getElementById('p2').style.display = 'block';
                        startLoop();
                    }
                }, err => alert("Erro GPS: " + err.message), { enableHighAccuracy: true });

                window.addEventListener('deviceorientation', e => {
                    userHeading = e.webkitCompassHeading || (360 - e.alpha) || 0;
                });
            } catch(e) { alert(e); }
        }

        function injectScene() {
            // minDistance 0 e maxDistance 0 desativa o corte autom√°tico do AR.js
            document.getElementById('scene-wrapper').innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                    renderer="logarithmicDepthBuffer: true; antialias: true;">
                    
                    <a-camera id="cam" gps-camera="minDistance: 0; maxDistance: 0;" rotation-reader></a-camera>
                    <a-entity id="world"></a-entity>
                </a-scene>
            `;
        }

        // ARQUIVOS
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file) return;
            let txt = "";
            if(file.name.toLowerCase().endsWith('.kmz')) {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.endsWith('.kml'));
                if(kmlName) txt = await content.files[kmlName].async("string");
            } else { txt = await file.text(); }
            if(txt) parseKML(txt);
        });

        function parseKML(xml) {
            const doc = new DOMParser().parseFromString(xml, "text/xml");
            const world = document.getElementById('world');
            world.innerHTML = '';
            targets = [];
            let c=0;
            for(let p of doc.getElementsByTagName("Placemark")) {
                let coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                let name = p.getElementsByTagName("name")[0]?.textContent || `Ponto ${c}`;
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    createColumn(lat, lon, name, c++);
                }
            }
            finishLoad();
        }

        function addTest() {
            createColumn(userLat + 0.0002, userLon, "TESTE NORTE", 999);
            finishLoad();
        }

        // --- A M√ÅGICA ACONTECE AQUI ---
        function createColumn(lat, lon, name, id) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            
            // ESTRAT√âGIA: COLUNA INFINITA
            // cylinder height="1000" -> Cria um poste de 1km de altura
            // position="0 0 0" -> Centralizado na coordenada GPS
            // material shader: flat -> Cor s√≥lida, sem sombra, brilha no sol
            // depthTest: false -> Aparece "na frente" de paredes e pr√©dios (Raio-X)
            
            el.innerHTML = `
                <a-entity class="marker-vis" visible="false">
                    <!-- PILAR VERMELHO GIGANTE (Vis√≠vel de qualquer altura) -->
                    <a-cylinder color="red" height="1000" radius="2" material="opacity: 0.5; shader: flat; depthTest: false;"></a-cylinder>
                    
                    <!-- N√öCLEO AMARELO (Para destacar o centro) -->
                    <a-cylinder color="yellow" height="1000" radius="0.2" material="shader: flat; depthTest: false;"></a-cylinder>
                    
                    <!-- TEXTO NO N√çVEL DOS OLHOS (Aprox) -->
                    <!-- Repetimos o texto em v√°rias alturas para garantir visibilidade -->
                    <a-text value="${name}" color="white" align="center" scale="30 30 30" position="0 5 0"  side="double" shader="msdf" font="roboto"></a-text>
                    <a-text value="${name}" color="white" align="center" scale="30 30 30" position="0 20 0" side="double" shader="msdf" font="roboto"></a-text>
                    <a-text value="${name}" color="white" align="center" scale="30 30 30" position="0 -10 0" side="double" shader="msdf" font="roboto"></a-text>
                </a-entity>
            `;
            
            document.getElementById('world').appendChild(el);
            targets.push({ id, name, lat, lon, el, dist: 0 });
        }

        function finishLoad() {
            document.getElementById('start').style.display = 'none';
            document.getElementById('menu-btn').style.display = 'block';
            updateList();
        }

        // UI
        function toggleList() { document.getElementById('list-panel').classList.toggle('open'); }

        function updateList() {
            const div = document.getElementById('list-content');
            div.innerHTML = '';
            targets.sort((a,b) => a.dist - b.dist).forEach(t => {
                const d = document.createElement('div');
                d.className = 'item';
                d.innerHTML = `<b>${t.name}</b> (${t.dist.toFixed(0)}m)`;
                d.onclick = () => selectTarget(t.id);
                div.appendChild(d);
            });
        }

        function selectTarget(id) {
            activeTarget = targets.find(t => t.id === id);
            
            // S√≥ mostra o objeto selecionado para n√£o poluir
            targets.forEach(t => {
                const vis = t.el.querySelector('.marker-vis');
                if(vis) vis.setAttribute('visible', t.id === id);
            });

            document.getElementById('hud').style.display = 'block';
            document.getElementById('guide-ui').style.display = 'block';
            document.getElementById('target-name').innerText = activeTarget.name;
            toggleList();
        }

        function stopNav() {
            activeTarget = null;
            targets.forEach(t => {
                const vis = t.el.querySelector('.marker-vis');
                if(vis) vis.setAttribute('visible', false);
            });
            document.getElementById('hud').style.display = 'none';
            document.getElementById('guide-ui').style.display = 'none';
        }

        // LOOPS
        function startLoop() {
            // Loop 1: Dist√¢ncia (1s)
            setInterval(() => {
                if(!userLat) return;
                targets.forEach(t => {
                    t.dist = haversine(userLat, userLon, t.lat, t.lon);
                });
                if(activeTarget) {
                    document.getElementById('dist-val').innerText = activeTarget.dist.toFixed(0) + "m";
                }
                updateList(); // Atualiza dist√¢ncias na lista
            }, 1000);

            // Loop 2: B√∫ssola (r√°pido)
            setInterval(() => {
                if(!activeTarget || !userLat) return;

                const bearing = getBearing(userLat, userLon, activeTarget.lat, activeTarget.lon);
                let angle = bearing - userHeading;
                while(angle < -180) angle += 360;
                while(angle > 180) angle -= 360;

                const icon = document.getElementById('arrow-icon');
                const txt = document.getElementById('guide-text');

                icon.style.transform = `rotate(${angle}deg)`;

                if(Math.abs(angle) < 15) {
                    icon.style.color = "#00ff00"; // Verde
                    txt.innerText = "EM FRENTE";
                    txt.style.color = "#00ff00";
                } else {
                    icon.style.color = "gold";
                    txt.innerText = angle > 0 ? "DIREITA" : "ESQUERDA";
                    txt.style.color = "white";
                }
            }, 50);
        }

        // MATH
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(destLng*Math.PI/180 - startLng*Math.PI/180) * Math.cos(destLat*Math.PI/180);
            const x = Math.cos(startLat*Math.PI/180)*Math.sin(destLat*Math.PI/180) - Math.sin(startLat*Math.PI/180)*Math.cos(destLat*Math.PI/180)*Math.cos(destLng*Math.PI/180 - startLng*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
