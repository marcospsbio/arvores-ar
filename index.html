<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Pro - Ajuste de Altura</title>

    <!-- A-Frame e AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }

        /* --- CONTROLES DE ALTURA (O SEGREDO PARA VER O OBJETO) --- */
        #height-controls {
            position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
            display: none; flex-direction: column; gap: 15px; z-index: 9999;
        }
        .h-btn {
            width: 60px; height: 60px; border-radius: 50%; border: 3px solid white;
            background: rgba(0, 0, 0, 0.7); color: white; font-size: 30px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .h-label {
            color: yellow; font-size: 12px; text-align: center; 
            text-shadow: 1px 1px 2px black; background: rgba(0,0,0,0.5); padding: 2px; border-radius: 4px;
        }

        /* --- SETA 2D --- */
        #guide-container {
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            z-index: 9000; display: none; text-align: center; pointer-events: none;
        }
        #guide-icon { font-size: 80px; color: gold; text-shadow: 0 2px 10px black; transition: 0.1s; }
        #guide-text { color: white; font-weight: bold; font-size: 18px; text-shadow: 0 2px 5px black; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px;}

        /* --- HUD --- */
        #hud {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.95); 
            padding: 15px; border-radius: 20px; border: 2px solid #f1c40f;
            text-align: center; color: white; z-index: 9995; display: none;
        }
        #hud-dist { font-size: 40px; font-weight: 900; margin: 5px 0; color: #fff; }

        /* --- MENU E TELA INICIAL --- */
        #menu-btn { position: fixed; top: 15px; left: 15px; z-index: 9995; padding: 10px; background: white; border: none; border-radius: 5px; font-weight: bold; display: none; }
        #list-panel { position: fixed; top: 0; left: -100%; width: 100%; height: 100%; background: #eee; z-index: 9998; transition: 0.3s; overflow-y: auto; }
        #list-panel.open { left: 0; }
        .list-item { padding: 20px; border-bottom: 1px solid #ccc; background: white; font-size: 16px; }
        
        #start { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .panel { background: white; padding: 30px; border-radius: 10px; width: 80%; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- SETA 2D -->
    <div id="guide-container">
        <div id="guide-icon">â¬†</div>
        <div id="guide-text">EM FRENTE</div>
    </div>

    <!-- CONTROLES DE ALTURA -->
    <div id="height-controls">
        <div class="h-label">AJUSTAR<br>ALTURA</div>
        <button class="h-btn" onclick="changeHeight(2)">â¬†</button>
        <div class="h-label" id="height-val">0m</div>
        <button class="h-btn" onclick="changeHeight(-2)">â¬‡</button>
    </div>

    <!-- HUD -->
    <div id="hud">
        <h3 id="hud-name" style="margin:0; color: yellow;">Destino</h3>
        <div id="hud-dist">0m</div>
        <div style="font-size:11px; color:#ccc">Use os botÃµes laterais se nÃ£o ver o objeto</div>
        <button onclick="stopNav()" style="margin-top:10px; padding:10px 30px; background:red; color:white; border:none; border-radius:20px; font-weight:bold;">PARAR</button>
    </div>

    <!-- MENU -->
    <button id="menu-btn" onclick="toggleList()">ðŸ“‚ LISTA</button>
    <div id="list-panel">
        <div style="padding:20px; background:white; display:flex; justify-content:space-between;">
            <h2>Destinos</h2> <button onclick="toggleList()">X</button>
        </div>
        <div id="list-items"></div>
    </div>

    <!-- TELA INICIAL -->
    <div id="start">
        <div class="panel" id="p1">
            <h2>AR Pro + Altura</h2>
            <p>Use o Ajuste Manual para encontrar objetos enterrados ou voando.</p>
            <button onclick="init()" style="padding:15px; width:100%; background:green; color:white; border:none; font-weight:bold; border-radius:5px;">INICIAR</button>
        </div>
        <div class="panel hidden" id="p2">
            <button onclick="document.getElementById('fileInput').click()" style="padding:15px; width:100%; background:blue; color:white; border:none; border-radius:5px;">ðŸ“‚ CARREGAR KMZ</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
            <br><br>
            <button onclick="addTest()" style="padding:10px; width:100%; background:#ccc; border:none; border-radius:5px;">+ Teste (20m Norte)</button>
        </div>
    </div>

    <!-- CENA 3D -->
    <div id="scene-wrapper"></div>

    <script>
        let targets = [];
        let currentTarget = null;
        let heightOffset = 0; // Ajuste manual de altura
        let userHeading = 0;
        let userLat = 0, userLon = 0;

        async function init() {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());

                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;
                    if(!document.getElementById('scene-wrapper').innerHTML) {
                        injectScene();
                        document.getElementById('p1').classList.add('hidden');
                        document.getElementById('p2').classList.remove('hidden');
                        startLoops();
                    }
                }, err => alert("Erro GPS: " + err.message), { enableHighAccuracy: true });

                window.addEventListener('deviceorientation', e => {
                    userHeading = e.webkitCompassHeading || (360 - e.alpha) || 0;
                });

            } catch(e) { alert(e); }
        }

        function injectScene() {
            document.getElementById('scene-wrapper').innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                    renderer="logarithmicDepthBuffer: true; antialias: true;">
                    <a-camera id="cam" gps-camera="minDistance: 0; maxDistance: 50000;" rotation-reader></a-camera>
                    <a-entity id="world"></a-entity>
                </a-scene>
            `;
        }

        // CARREGAR DADOS
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file) return;
            let txt = "";
            if(file.name.toLowerCase().endsWith('.kmz')) {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.endsWith('.kml'));
                if(kmlName) txt = await content.files[kmlName].async("string");
            } else { txt = await file.text(); }
            if(txt) parseKML(txt);
        });

        function parseKML(xml) {
            const doc = new DOMParser().parseFromString(xml, "text/xml");
            const world = document.getElementById('world');
            world.innerHTML = '';
            targets = [];
            let c = 0;
            for(let p of doc.getElementsByTagName("Placemark")) {
                let coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                let name = p.getElementsByTagName("name")[0]?.textContent || `Ponto ${c}`;
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    createObj(lat, lon, name, c++);
                }
            }
            finishLoad();
        }

        function addTest() {
            createObj(userLat + 0.0002, userLon, "TESTE NORTE", 999);
            finishLoad();
        }

        function createObj(lat, lon, name, id) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            
            // MODELO: ANÃ‰IS GIGANTES VERMELHOS
            // depthTest: false -> VÃª atravÃ©s das paredes
            el.innerHTML = `
                <a-entity class="visual-container" position="0 0 0">
                    <a-text value="${name}" align="center" color="yellow" position="0 5 0" scale="15 15 15" look-at="#cam" side="double"></a-text>
                    
                    <!-- AnÃ©is ConcÃªntricos (Alvo) -->
                    <a-torus color="red" radius="3" radius-tubular="0.2" rotation="0 0 0" material="opacity: 0.8; depthTest: false;"></a-torus>
                    <a-torus color="white" radius="2" radius-tubular="0.2" rotation="0 0 0" material="opacity: 0.8; depthTest: false;"></a-torus>
                    <a-sphere color="red" radius="1" material="opacity: 0.8; depthTest: false;"></a-sphere>

                    <!-- Linha Vertical Infinita -->
                    <a-cylinder color="red" height="200" radius="0.1" position="0 0 0" material="opacity: 0.5; depthTest: false;"></a-cylinder>
                </a-entity>
            `;
            document.getElementById('world').appendChild(el);
            targets.push({ id, name, lat, lon, el, dist: 0 });
        }

        function finishLoad() {
            document.getElementById('start').classList.add('hidden');
            document.getElementById('menu-btn').style.display = 'block';
            updateList();
        }

        // FUNÃ‡Ã•ES DE CONTROLE
        function toggleList() { document.getElementById('list-panel').classList.toggle('open'); }

        function updateList() {
            const div = document.getElementById('list-items');
            div.innerHTML = '';
            targets.sort((a,b) => a.dist - b.dist).forEach(t => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `<b>${t.name}</b> (${t.dist.toFixed(0)}m)`;
                item.onclick = () => selectTarget(t.id);
                div.appendChild(item);
            });
        }

        function selectTarget(id) {
            currentTarget = targets.find(t => t.id === id);
            
            // Reset Altura
            heightOffset = 0; 
            document.getElementById('height-val').innerText = "0m";
            updateHeights();

            // UI
            document.getElementById('hud').style.display = 'block';
            document.getElementById('height-controls').style.display = 'flex';
            document.getElementById('guide-container').style.display = 'block';
            document.getElementById('hud-name').innerText = currentTarget.name;
            
            // Destacar visualmente (Fica maior)
            targets.forEach(t => {
                const vis = t.el.querySelector('a-torus');
                if(vis) vis.setAttribute('color', t.id === id ? 'lime' : 'red');
            });

            toggleList();
        }

        function stopNav() {
            currentTarget = null;
            document.getElementById('hud').style.display = 'none';
            document.getElementById('height-controls').style.display = 'none';
            document.getElementById('guide-container').style.display = 'none';
        }

        // NOVIDADE: AJUSTE DE ALTURA
        function changeHeight(val) {
            heightOffset += val;
            document.getElementById('height-val').innerText = heightOffset + "m";
            updateHeights();
        }

        function updateHeights() {
            // Move o container visual dentro da entidade GPS
            targets.forEach(t => {
                const visual = t.el.querySelector('.visual-container');
                if(visual) visual.setAttribute('position', `0 ${heightOffset} 0`);
            });
        }

        // LOOPS
        function startLoops() {
            setInterval(() => {
                if(!userLat) return;
                targets.forEach(t => {
                    t.dist = haversine(userLat, userLon, t.lat, t.lon);
                    
                    // Escala para nÃ£o sumir
                    const scale = Math.max(1, t.dist / 10);
                    const vis = t.el.querySelector('.visual-container');
                    if(vis) vis.setAttribute('scale', `${scale} ${scale} ${scale}`);

                    t.el.setAttribute('visible', t.dist < 10000);
                });
                if(currentTarget) document.getElementById('hud-dist').innerText = currentTarget.dist.toFixed(0) + "m";
            }, 1000);

            // Loop da Seta 2D
            setInterval(() => {
                if(!currentTarget || !userLat) return;

                const bearing = getBearing(userLat, userLon, currentTarget.lat, currentTarget.lon);
                let angle = bearing - userHeading;
                while(angle < -180) angle += 360;
                while(angle > 180) angle -= 360;

                const icon = document.getElementById('guide-icon');
                const text = document.getElementById('guide-text');
                
                icon.style.transform = `rotate(${angle}deg)`;

                if(Math.abs(angle) < 15) {
                    text.innerText = "EM FRENTE";
                    text.style.color = "#0f0";
                    icon.style.color = "#0f0";
                } else {
                    text.innerText = angle > 0 ? "DIREITA" : "ESQUERDA";
                    text.style.color = "white";
                    icon.style.color = "gold";
                }
            }, 50);
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(destLng*Math.PI/180 - startLng*Math.PI/180) * Math.cos(destLat*Math.PI/180);
            const x = Math.cos(startLat*Math.PI/180)*Math.sin(destLat*Math.PI/180) - Math.sin(startLat*Math.PI/180)*Math.cos(destLat*Math.PI/180)*Math.cos(destLng*Math.PI/180 - startLng*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
