<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Guia & Radar</title>

    <script>
        window.onerror = function(msg) {
            var logElem = document.getElementById('console-log');
            if (logElem) logElem.innerText = "ERRO: " + msg;
        };
    </script>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js" crossorigin="anonymous"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js' crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #222; }
        
        #console-log {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.5); color: #00ff00;
            font-family: monospace; font-size: 10px; padding: 2px;
            z-index: 9990; pointer-events: none; text-align: center;
        }

        /* --- UI RADAR --- */
        #radar-container {
            position: fixed; top: 10px; right: 10px;
            width: 120px; height: 120px;
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #444; border-radius: 50%;
            z-index: 9995; display: none; /* Escondido at√© carregar */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #radar-center {
            position: absolute; top: 50%; left: 50%;
            width: 8px; height: 8px; background: #00ff00;
            border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 5px #00ff00;
        }
        .radar-dot {
            position: absolute; width: 6px; height: 6px;
            background: yellow; border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .radar-dot.target { background: red; width: 8px; height: 8px; z-index: 2; border: 1px solid white; }

        /* --- UI MENUS --- */
        #menu-btn {
            position: fixed; top: 10px; left: 10px; z-index: 9995;
            background: white; border: none; border-radius: 5px;
            width: 40px; height: 40px; font-size: 24px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: none;
        }

        #sidebar {
            position: fixed; top: 0; left: -320px; width: 280px; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 9996;
            transition: left 0.3s ease; box-shadow: 2px 0 15px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header { padding: 15px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; }
        #tree-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .list-item:hover { background: #f0f0f0; }
        .list-item.selected { background: #d5f5e3; border-left: 5px solid #27ae60; }

        /* --- HUD INFERIOR --- */
        #nav-info {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 30px; z-index: 9995; text-align: center;
            display: none; min-width: 200px; border: 2px solid #f1c40f;
        }
        .btn-stop { background: #c0392b; border: none; color: white; padding: 5px 15px; border-radius: 15px; margin-top: 5px; font-size: 12px; cursor: pointer; }

        /* --- TELA INICIAL --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .panel { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 300px; }
        .btn { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <!-- Radar -->
    <div id="radar-container">
        <div id="radar-center"></div>
        <!-- Pontos ser√£o injetados via JS -->
    </div>

    <!-- Menu -->
    <button id="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div id="sidebar">
        <div class="sidebar-header">
            <span>üìç √Årvores Pr√≥ximas</span>
            <button onclick="toggleSidebar()" style="background:none;border:none;color:white;font-size:20px;">‚úï</button>
        </div>
        <ul id="tree-list"><li style="padding:20px;text-align:center;color:#888">Carregue o KMZ...</li></ul>
    </div>

    <!-- Info Navega√ß√£o -->
    <div id="nav-info">
        <strong id="target-name" style="font-size: 18px; color: #f1c40f;">Destino</strong><br>
        <span id="target-dist" style="font-size: 24px; font-weight: bold;">-- m</span><br>
        <span style="font-size: 12px; color: #ccc;">Siga a linha amarela</span><br>
        <button class="btn-stop" onclick="stopNavigation()">Parar Guia</button>
    </div>

    <div id="console-log">Aguardando...</div>

    <!-- Telas -->
    <div id="start-screen">
        <div class="panel" id="panel-perm">
            <h2>üå≤ AR Explorer</h2>
            <p>Ative GPS e C√¢mera para come√ßar.</p>
            <button class="btn" onclick="startApp()">INICIAR</button>
        </div>
        <div class="panel hidden" id="panel-file">
            <h3>Carregar Mapa</h3>
            <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Abrir KMZ</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
            <br><br>
            <button class="btn" style="background:#2980b9" onclick="addTestTree()">üå≤ Teste (Norte)</button>
        </div>
    </div>

    <!-- Cena 3D -->
    <div id="scene-wrapper"></div>

    <script>
        const log = (msg) => document.getElementById('console-log').innerText = msg;
        
        // --- ESTADO GLOBAL ---
        let treeEntities = [];
        let currentTargetId = null;
        let userLat = 0, userLon = 0, userHeading = 0;
        
        // Linha Guia (Elemento A-Frame)
        let guideLineEl = null;

        // --- 1. STARTUP ---
        async function startApp() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());
                
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }

                if(!navigator.geolocation) throw new Error("Sem GPS");

                navigator.geolocation.getCurrentPosition(pos => {
                    injectScene();
                    document.getElementById('panel-perm').classList.add('hidden');
                    document.getElementById('panel-file').classList.remove('hidden');
                    
                    // Listeners
                    window.addEventListener('deviceorientation', e => {
                        if(e.webkitCompassHeading) userHeading = e.webkitCompassHeading;
                        else if(e.alpha) userHeading = e.alpha;
                    });
                    
                    // Loops
                    setInterval(updateGameLoop, 1000); // GPS e Dist√¢ncias (Lento)
                    setInterval(updateVisuals, 50);   // Radar e Linha (R√°pido)

                    log("GPS OK. Pronto para carregar.");
                }, err => alert("Erro GPS: " + err.message));

            } catch(e) { alert(e.message); }
        }

        function injectScene() {
            const wrapper = document.getElementById('scene-wrapper');
            wrapper.innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" renderer="logarithmicDepthBuffer: true;">
                    <a-camera id="cam" gps-camera="minDistance: 5; maxDistance: 5000;" rotation-reader></a-camera>
                    
                    <!-- Container das √Årvores -->
                    <a-entity id="tree-container"></a-entity>
                    
                    <!-- Linha Guia (Din√¢mica) -->
                    <a-entity id="guide-line" line="start: 0 -1 0; end: 0 -1 -5; color: #f1c40f; opacity: 0.8" visible="false"></a-entity>
                </a-scene>
            `;
            // Espera carregar para pegar referencia da linha
            setTimeout(() => {
                guideLineEl = document.getElementById('guide-line');
            }, 1000);
        }

        // --- 2. ARQUIVO E PARSE ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.toLowerCase().endsWith('.kml'));
                const kmlText = await content.files[kmlName].async("string");
                parseKML(kmlText);
                
                // UI Updates
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('menu-btn').style.display = 'block';
                document.getElementById('radar-container').style.display = 'block';
                toggleSidebar();
            } catch(err) { alert("Erro no arquivo."); }
        });

        function parseKML(xml) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xml, "text/xml");
            const placemarks = xmlDoc.getElementsByTagName("Placemark");
            const container = document.getElementById('tree-container');
            
            treeEntities = [];
            container.innerHTML = '';
            
            let count = 0;
            for(let p of placemarks) {
                const coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                const name = p.getElementsByTagName("name")[0]?.textContent || `√Årvore ${count+1}`;
                
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    
                    // Visual 3D
                    const el = document.createElement('a-entity');
                    el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
                    
                    // Cria a √°rvore visual
                    el.innerHTML = `
                        <a-entity position="0 0 0" scale="2 2 2" class="tree-model">
                            <a-text value="${name}" align="center" color="#FFF" position="0 5 0" look-at="[gps-camera]" scale="4 4 4"></a-text>
                            <a-cone color="#2ecc71" position="0 2 0" height="4" radius-bottom="1.5"></a-cone>
                            <a-cylinder color="#5d4037" position="0 0.5 0" radius="0.4" height="1"></a-cylinder>
                        </a-entity>
                    `;
                    container.appendChild(el);

                    treeEntities.push({
                        id: count, name: name, lat: lat, lon: lon, el: el, 
                        dist: 9999,
                        radarDot: createRadarDot() // Cria pontinho no radar
                    });
                    count++;
                }
            }
            updateList();
        }

        // --- 3. NAVEGA√á√ÉO E L√ìGICA ---
        
        function selectTarget(id) {
            currentTargetId = id;
            const tree = treeEntities.find(t => t.id === id);
            
            // UI HUD
            document.getElementById('nav-info').style.display = 'block';
            document.getElementById('target-name').innerText = tree.name;
            
            // Ativa Linha
            if(guideLineEl) guideLineEl.setAttribute('visible', 'true');
            
            toggleSidebar();
            updateList();
        }

        function stopNavigation() {
            currentTargetId = null;
            document.getElementById('nav-info').style.display = 'none';
            if(guideLineEl) guideLineEl.setAttribute('visible', 'false');
            updateList();
        }

        // --- LOOPS ---

        // Loop 1: Lento (GPS e Dist√¢ncias)
        function updateGameLoop() {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                
                treeEntities.forEach(tree => {
                    // Calcula dist
                    tree.dist = haversine(userLat, userLon, tree.lat, tree.lon);
                    
                    // Cores por dist√¢ncia
                    const model = tree.el.querySelector('.tree-model');
                    const cone = tree.el.querySelector('a-cone');
                    
                    if(tree.dist < 50) {
                        // Muito Perto: Verde e Gigante
                        cone.setAttribute('color', '#00ff00');
                        model.setAttribute('scale', '3 3 3'); 
                    } else if (tree.dist < 200) {
                        // M√©dio: Amarelo
                        cone.setAttribute('color', 'yellow');
                        model.setAttribute('scale', '2 2 2');
                    } else {
                        // Longe: Vermelho
                        cone.setAttribute('color', '#c0392b');
                        model.setAttribute('scale', '2 2 2');
                    }

                    // Garante visibilidade se < 500m
                    tree.el.setAttribute('visible', tree.dist < 500);
                });

                // Atualiza HUD texto
                if(currentTargetId !== null) {
                    const target = treeEntities.find(t => t.id === currentTargetId);
                    if(target) document.getElementById('target-dist').innerText = target.dist.toFixed(0) + " m";
                }

                // Atualiza n√∫meros na lista (se aberta)
                if(document.getElementById('sidebar').classList.contains('open')) updateList();

            }, null, { enableHighAccuracy: true });
        }

        // Loop 2: R√°pido (Visuais, Radar, Linha)
        function updateVisuals() {
            // A. Atualiza Radar
            const radarRadius = 55; // px
            const scanRange = 300; // Metros que o radar enxerga
            
            treeEntities.forEach(tree => {
                if(!tree.radarDot) return;

                // Se for o alvo selecionado, sempre mostra no radar (mesmo longe)
                const isTarget = (tree.id === currentTargetId);
                
                if(tree.dist > scanRange && !isTarget) {
                    tree.radarDot.style.display = 'none';
                    return;
                }
                tree.radarDot.style.display = 'block';

                // L√≥gica Radar: Delta Lat/Lon relativo ao heading
                // 1. Pega √¢ngulo at√© a √°rvore
                const bearing = getBearing(userLat, userLon, tree.lat, tree.lon);
                // 2. Relativo ao para onde estou olhando
                let relAngle = bearing - userHeading; 
                // Converte para rad
                const relRad = (relAngle - 90) * (Math.PI / 180); // -90 para alinhar ao topo

                // 3. Dist√¢ncia no radar (limitada √† borda)
                // Normaliza: 0 a 1 (onde 1 √© scanRange)
                let distRatio = tree.dist / scanRange;
                if(distRatio > 1) distRatio = 1; // Clampa na borda
                
                const r = distRatio * radarRadius;
                
                const x = 60 + r * Math.cos(relRad); // 60 √© centro do div 120px
                const y = 60 + r * Math.sin(relRad);

                tree.radarDot.style.left = x + 'px';
                tree.radarDot.style.top = y + 'px';
                
                // Estiliza o ponto alvo
                if(isTarget) {
                    tree.radarDot.classList.add('target');
                    tree.radarDot.style.background = 'red';
                } else {
                    tree.radarDot.classList.remove('target');
                    tree.radarDot.style.background = tree.dist < 50 ? '#00ff00' : 'yellow';
                }
            });

            // B. Atualiza Linha Guia (Faixa)
            if(currentTargetId !== null && guideLineEl) {
                const target = treeEntities.find(t => t.id === currentTargetId);
                // Precisamos da posi√ß√£o do objeto A-Frame no mundo 3D
                const obj3D = target.el.object3D;
                
                // A-Frame Position vector
                const vec = obj3D.position;
                
                // Atualiza atributo 'line'
                // Start: P√©s do usu√°rio (0, -1, 0)
                // End: Posi√ß√£o da √°rvore
                guideLineEl.setAttribute('line', `start: 0 -1 0; end: ${vec.x} ${vec.y} ${vec.z}; color: #f1c40f; opacity: 0.8`);
            }
        }

        // --- UI AUXILIAR ---
        function createRadarDot() {
            const d = document.createElement('div');
            d.className = 'radar-dot';
            document.getElementById('radar-container').appendChild(d);
            return d;
        }

        function updateList() {
            const list = document.getElementById('tree-list');
            // S√≥ recria se o n√∫mero de itens mudar ou for selecionado para evitar lag, 
            // mas aqui vamos simplificar limpando e re-renderizando texto
            list.innerHTML = '';
            const sorted = [...treeEntities].sort((a,b) => a.dist - b.dist);
            
            sorted.forEach(t => {
                const li = document.createElement('li');
                li.className = `list-item ${t.id === currentTargetId ? 'selected' : ''}`;
                li.innerHTML = `<span>${t.name}</span> <small>${t.dist.toFixed(0)}m</small>`;
                li.onclick = () => selectTarget(t.id);
                list.appendChild(li);
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- MATH UTILS ---
        function toRad(d) { return d * Math.PI / 180; }
        function toDeg(r) { return r * 180 / Math.PI; }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
            const ŒîœÜ = toRad(lat2-lat1), ŒîŒª = toRad(lon2-lon1);
            const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(toRad(lon2-lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
            return (toDeg(Math.atan2(y, x)) + 360) % 360;
        }

        function addTestTree() {
            const fake = {
                id: 999, name: "Teste", lat: userLat + 0.0003, lon: userLon, 
                el: document.createElement('a-entity'), dist: 0, radarDot: createRadarDot()
            };
            // Adiciona visual fake na cena
            fake.el.setAttribute('gps-entity-place', `latitude: ${fake.lat}; longitude: ${fake.lon};`);
            document.getElementById('tree-container').appendChild(fake);
            treeEntities.push(fake);
            alert("√Årvore Teste adicionada!");
            toggleSidebar();
        }
    </script>
</body>
</html>
