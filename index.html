<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Navegador Pro</title>

    <!-- Bibliotecas -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }

        /* --- UI: SETA DIRECIONAL GIGANTE (2D) --- */
        #guide-arrow-container {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            z-index: 9000; display: none; pointer-events: none;
            width: 200px; height: 200px;
            justify-content: center; align-items: center;
        }
        #guide-arrow-icon {
            font-size: 100px; color: rgba(255, 215, 0, 0.8); 
            text-shadow: 0 0 10px #000;
            display: block; transition: transform 0.1s linear;
        }
        #guide-hint {
            position: absolute; top: 120px; width: 100%; text-align: center;
            color: white; font-weight: bold; text-shadow: 1px 1px 2px black;
            background: rgba(0,0,0,0.5); padding: 5px; border-radius: 10px;
        }

        /* --- HUD INFERIOR --- */
        #hud {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(20, 20, 20, 0.95); 
            padding: 20px; border-radius: 20px; border: 2px solid #f1c40f;
            text-align: center; color: white; z-index: 9995; display: none;
        }
        #hud-dist { font-size: 45px; font-weight: 900; margin: 5px 0; color: #fff; }
        .btn-stop {
            background: #e74c3c; color: white; padding: 12px 40px; border: none; 
            border-radius: 50px; font-weight: bold; margin-top: 10px; font-size: 16px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        /* --- RADAR --- */
        #radar-container {
            position: fixed; top: 15px; right: 15px; width: 100px; height: 100px;
            background: rgba(0, 30, 0, 0.8); border: 2px solid #0f0; border-radius: 50%;
            z-index: 9990; display: none;
        }
        #radar-center {
            position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: #fff; transform: translate(-50%,-50%); border-radius: 50%;
        }
        .radar-dot {
            position: absolute; width: 8px; height: 8px; background: yellow; border-radius: 50%; transform: translate(-50%,-50%);
        }
        .radar-dot.target { background: #ff0000; width: 12px; height: 12px; border: 2px solid #fff; z-index: 10; box-shadow: 0 0 8px red; }

        /* --- MENU --- */
        #menu-btn {
            position: fixed; top: 15px; left: 15px; z-index: 9995; background: white;
            border: none; padding: 12px; border-radius: 8px; font-weight: bold; display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #list-panel {
            position: fixed; top: 0; left: -100%; width: 100%; height: 100%;
            background: #f4f4f4; z-index: 9998; transition: 0.3s; padding: 0; box-sizing: border-box;
        }
        #list-panel.open { left: 0; }
        .list-header { padding: 20px; background: white; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .list-item { padding: 20px; border-bottom: 1px solid #ddd; background: white; font-size: 16px; }
        .list-item:active { background: #eee; }

        /* --- TELA INICIAL --- */
        #start {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111;
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .panel { background: #fff; color: #333; padding: 30px; border-radius: 15px; width: 80%; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- SETA DE NAVEGAÃ‡ÃƒO 2D (SEMPRE VISÃVEL) -->
    <div id="guide-arrow-container">
        <!-- Ãcone de Seta (Unicode) -->
        <div id="guide-arrow-icon">â¬†</div> 
        <div id="guide-hint">VIRE O CELULAR</div>
    </div>

    <!-- Radar -->
    <div id="radar-container"><div id="radar-center"></div></div>

    <!-- Menu -->
    <button id="menu-btn" onclick="toggleList()">ðŸ“‚ LISTA</button>
    <div id="list-panel">
        <div class="list-header">
            <h2 style="margin:0">Destinos</h2>
            <button onclick="toggleList()" style="padding:5px 15px; font-size:20px;">âœ•</button>
        </div>
        <div id="items-container"></div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <h3 id="hud-name" style="margin:0; color: #f1c40f">Destino</h3>
        <div id="hud-dist">0m</div>
        <div style="color:#ccc; font-size:12px; margin-bottom:10px;">Siga a Seta na Tela</div>
        <button class="btn-stop" onclick="stopNav()">PARAR NAVEGAÃ‡ÃƒO</button>
    </div>

    <!-- Start Screen -->
    <div id="start">
        <div class="panel" id="p1">
            <h2>AR Navegador</h2>
            <p>Modo BÃºssola 2D + Marcador 3D Infinito</p>
            <button onclick="init()" style="width:100%; padding:15px; background:#27ae60; color:white; border:none; font-weight:bold; border-radius:5px; font-size:16px;">INICIAR</button>
        </div>
        <div class="panel hidden" id="p2">
            <h3>Carregar Mapa</h3>
            <button onclick="document.getElementById('fileInput').click()" style="width:100%; padding:12px; background:#3498db; color:white; border:none; border-radius:5px; margin-bottom:15px;">ðŸ“‚ ABRIR KMZ / KML</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
            <hr>
            <button onclick="addTest()" style="background:none; border:1px solid #ccc; padding:8px; border-radius:5px; width:100%; color:#555;">+ Teste (20m Norte)</button>
        </div>
    </div>

    <!-- CENA 3D -->
    <div id="scene-container"></div>

    <script>
        let targets = [];
        let activeTarget = null;
        let userLat=0, userLon=0, userHeading=0;

        // 1. INICIAR
        async function init() {
            try {
                // PermissÃ£o BÃºssola iOS
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }
                // PermissÃ£o CÃ¢mera
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());

                // GPS
                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;
                    if(!document.querySelector('a-scene')) {
                        injectScene();
                        document.getElementById('p1').classList.add('hidden');
                        document.getElementById('p2').classList.remove('hidden');
                        startLoop();
                    }
                }, err => alert("GPS Error: " + err.message), { enableHighAccuracy: true });

                // BÃºssola
                window.addEventListener('deviceorientation', e => {
                    if(e.webkitCompassHeading) userHeading = e.webkitCompassHeading;
                    else if(e.alpha) userHeading = 360 - e.alpha;
                });

            } catch(e) { alert(e.message); }
        }

        function injectScene() {
            // near: 0.1 resolve o problema de objetos sumindo perto (6m)
            // logarithmicDepthBuffer: true resolve tremedeira visual
            document.getElementById('scene-container').innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                    renderer="logarithmicDepthBuffer: true; antialias: true;">
                    
                    <a-camera id="cam" gps-camera="minDistance: 0; maxDistance: 10000;" near="0.1" far="20000" rotation-reader>
                    </a-camera>

                    <a-entity id="world"></a-entity>
                </a-scene>
            `;
        }

        // 2. CARREGAR DADOS
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file) return;
            let txt = "";
            if(file.name.toLowerCase().endsWith('.kmz')) {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.endsWith('.kml'));
                if(kmlName) txt = await content.files[kmlName].async("string");
            } else { txt = await file.text(); }
            if(txt) parseKML(txt);
        });

        function parseKML(xml) {
            const doc = new DOMParser().parseFromString(xml, "text/xml");
            const world = document.getElementById('world');
            world.innerHTML = '';
            targets = [];
            let count = 0;
            
            for(let p of doc.getElementsByTagName("Placemark")) {
                let coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                let name = p.getElementsByTagName("name")[0]?.textContent || `Ponto ${count}`;
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    createMarker(lat, lon, name, count++);
                }
            }
            finishLoad();
        }

        function addTest() {
            // Cria ponto 20m ao Norte (seguro para nÃ£o cortar)
            createMarker(userLat + 0.0002, userLon, "TESTE NORTE", 999);
            finishLoad();
        }

        function createMarker(lat, lon, name, id) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            
            // VISUAL DO MARCADOR (SINALIZADOR INFINITO)
            // position y=0 Ã© o nÃ­vel da cÃ¢mera (olho).
            // O cilindro branco vai de -50 a +50, garantindo que vc veja mesmo se o GPS errar altitude.
            // look-at faz o texto girar pra vc.
            el.innerHTML = `
                <a-entity class="marker-visual" position="0 0 0">
                    <!-- Texto Gigante -->
                    <a-text value="${name}\n--- m" align="center" color="#f1c40f" position="0 5 0" scale="15 15 15" look-at="[gps-camera]" side="double" font="roboto"></a-text>
                    
                    <!-- Coluna de Luz (VisÃ­vel atravÃ©s de paredes) -->
                    <a-cylinder color="#e74c3c" height="200" radius="0.5" position="0 0 0" opacity="0.6" material="depthTest: false;"></a-cylinder>
                    
                    <!-- Base (Alvo) -->
                    <a-ring color="white" radius-inner="1" radius-outer="2" rotation="-90 0 0" material="shader: flat; depthTest: false;"></a-ring>
                </a-entity>
            `;
            document.getElementById('world').appendChild(el);

            const dot = document.createElement('div');
            dot.className = 'radar-dot';
            document.getElementById('radar-container').appendChild(dot);

            targets.push({ id, name, lat, lon, el, dot, dist: 0 });
        }

        function finishLoad() {
            document.getElementById('start').classList.add('hidden');
            document.getElementById('menu-btn').style.display = 'block';
            document.getElementById('radar-container').style.display = 'block';
            updateList();
        }

        // 3. UI e CONTROLES
        function toggleList() { document.getElementById('list-panel').classList.toggle('open'); }

        function updateList() {
            const div = document.getElementById('items-container');
            div.innerHTML = '';
            targets.sort((a,b) => a.dist - b.dist).forEach(t => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<b>${t.name}</b> <br><small>${t.dist.toFixed(0)}m</small>`;
                d.onclick = () => selectTarget(t.id);
                div.appendChild(d);
            });
        }

        function selectTarget(id) {
            if(activeTarget) activeTarget.dot.classList.remove('target');
            activeTarget = targets.find(t => t.id === id);
            activeTarget.dot.classList.add('target');
            
            document.getElementById('hud').style.display = 'block';
            document.getElementById('hud-name').innerText = activeTarget.name;
            document.getElementById('guide-arrow-container').style.display = 'flex'; // Mostra a Seta 2D
            toggleList();
        }

        function stopNav() {
            if(activeTarget) activeTarget.dot.classList.remove('target');
            activeTarget = null;
            document.getElementById('hud').style.display = 'none';
            document.getElementById('guide-arrow-container').style.display = 'none';
        }

        // 4. LOOPS DE CÃLCULO
        function startLoop() {
            // Loop Lento (DistÃ¢ncia e Texto) - 1 seg
            setInterval(() => {
                if(!userLat) return;
                targets.forEach(t => {
                    t.dist = haversine(userLat, userLon, t.lat, t.lon);
                    
                    // Atualiza texto 3D
                    const txt = t.el.querySelector('a-text');
                    if(txt) txt.setAttribute('value', `${t.name}\n${t.dist.toFixed(0)}m`);

                    // Escala DinÃ¢mica (Se longe > 50m, aumenta. Se perto, mantÃ©m 1x)
                    const scale = Math.max(1, t.dist / 20);
                    const vis = t.el.querySelector('.marker-visual');
                    if(vis) vis.setAttribute('scale', `${scale} ${scale} ${scale}`);

                    // Oculta se > 10km
                    t.el.setAttribute('visible', t.dist < 10000);
                });
                if(activeTarget) document.getElementById('hud-dist').innerText = activeTarget.dist.toFixed(0) + "m";
            }, 1000);

            // Loop RÃ¡pido (Radar e Seta 2D) - 50ms
            setInterval(() => {
                if(!userLat) return;
                
                // Atualizar Radar e Seta
                targets.forEach(t => {
                    const bearing = getBearing(userLat, userLon, t.lat, t.lon);
                    let angle = bearing - userHeading;
                    // Normaliza (-180 a 180)
                    while(angle < -180) angle += 360;
                    while(angle > 180) angle -= 360;

                    // Atualiza Radar
                    const r = 40; 
                    const rad = angle * (Math.PI / 180);
                    t.dot.style.left = (50 + r * Math.sin(rad)) + '%';
                    t.dot.style.top = (50 - r * Math.cos(rad)) + '%';

                    // Se for o alvo ativo, gira a Seta 2D gigante
                    if(activeTarget && t.id === activeTarget.id) {
                        const arrow = document.getElementById('guide-arrow-icon');
                        // A seta aponta para cima (0 deg). Se o alvo estÃ¡ a +90 deg (direita), rodamos a seta 90 deg.
                        arrow.style.transform = `rotate(${angle}deg)`;
                        
                        // Feedback de texto na seta
                        const hint = document.getElementById('guide-hint');
                        if(Math.abs(angle) < 10) {
                            hint.innerText = "EM FRENTE";
                            arrow.style.color = "#00ff00"; // Verde
                        } else {
                            hint.innerText = angle > 0 ? "DIREITA" : "ESQUERDA";
                            arrow.style.color = "rgba(255, 215, 0, 0.8)"; // Amarelo
                        }
                    }
                });
            }, 50);
        }

        // Helper Math
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(destLng*Math.PI/180 - startLng*Math.PI/180) * Math.cos(destLat*Math.PI/180);
            const x = Math.cos(startLat*Math.PI/180)*Math.sin(destLat*Math.PI/180) - Math.sin(startLat*Math.PI/180)*Math.cos(destLat*Math.PI/180)*Math.cos(destLng*Math.PI/180 - startLng*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
    </script>
</body>
</html>
