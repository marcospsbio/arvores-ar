<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR √Årvores - Navega√ß√£o GPS</title>

    <!-- Scripts de Tratamento de Erro -->
    <script>
        window.onerror = function(msg) {
            var logElem = document.getElementById('console-log');
            if (logElem) logElem.innerText = "ERRO: " + msg;
        };
    </script>

    <!-- Bibliotecas AR -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js" crossorigin="anonymous"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js' crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #222; }
        
        /* --- UI CAMADAS --- */
        #console-log {
            position: fixed; top: 0; left: 50px; right: 0;
            background: rgba(0,0,0,0.5); color: #00ff00;
            font-family: monospace; font-size: 10px; padding: 2px;
            z-index: 9990; pointer-events: none; text-align: center; white-space: nowrap; overflow: hidden;
        }

        /* Tela Inicial */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* Bot√£o Menu Hamburguer */
        #menu-btn {
            position: fixed; top: 10px; left: 10px; z-index: 9995;
            background: white; border: none; border-radius: 5px;
            width: 40px; height: 40px; font-size: 24px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: none; /* Escondido at√© iniciar */
        }

        /* Menu Lateral Retr√°til */
        #sidebar {
            position: fixed; top: 0; left: -300px; width: 280px; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9996;
            transition: left 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; }
        
        .sidebar-header {
            padding: 15px; background: #2c3e50; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        #tree-list {
            list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1;
        }
        .list-item {
            padding: 15px; border-bottom: 1px solid #eee; cursor: pointer;
            display: flex; justify-content: space-between;
        }
        .list-item:hover { background: #f0f0f0; }
        .list-item small { color: #666; }
        .list-item.selected { background: #d5f5e3; border-left: 5px solid #27ae60; }

        /* HUD da Seta de Navega√ß√£o */
        #nav-hud {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 9992; text-align: center; display: none; pointer-events: none;
        }
        
        /* C√≠rculo da seta */
        .arrow-circle {
            width: 80px; height: 80px; background: rgba(0,0,0,0.6);
            border-radius: 50%; border: 2px solid white;
            display: flex; justify-content: center; align-items: center;
            margin: 0 auto 10px auto;
            transition: transform 0.1s linear; /* Suaviza rota√ß√£o */
        }
        
        .arrow-icon {
            font-size: 40px; color: #00ff00; font-weight: bold;
        }

        .nav-info {
            background: rgba(0,0,0,0.7); color: white; padding: 8px 15px;
            border-radius: 20px; font-size: 14px; text-shadow: 1px 1px 2px black;
        }

        /* Estilos Gerais */
        .panel { background: white; padding: 20px; border-radius: 10px; text-align: center; width: 80%; max-width: 300px; }
        .btn { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 5px; width: 100%; margin-top: 10px; font-size: 16px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Bot√£o Menu -->
    <button id="menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Menu Lateral -->
    <div id="sidebar">
        <div class="sidebar-header">
            <span>üìç Pontos (<span id="count-display">0</span>)</span>
            <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        </div>
        <ul id="tree-list">
            <li style="padding:20px; text-align:center; color:#999;">Carregue um mapa primeiro.</li>
        </ul>
    </div>

    <!-- HUD de Navega√ß√£o (Seta) -->
    <div id="nav-hud">
        <div class="arrow-circle" id="arrow-dial">
            <div class="arrow-icon">‚¨Ü</div>
        </div>
        <div class="nav-info">
            <strong id="target-name">Selecionar Destino</strong><br>
            <span id="target-dist">-- m</span>
        </div>
        <button onclick="stopNavigation()" style="pointer-events:auto; background:#c0392b; border:none; color:white; padding:5px 10px; border-radius:15px; margin-top:5px; font-size:12px;">Parar</button>
    </div>

    <!-- Logs -->
    <div id="console-log">Aguardando...</div>

    <!-- Tela Inicial -->
    <div id="start-screen">
        <div class="panel" id="panel-permission">
            <h2>üß≠ AR Navigator</h2>
            <p>Precisamos de GPS e Orienta√ß√£o.</p>
            <button class="btn" onclick="startApp()">INICIAR</button>
        </div>
        
        <div class="panel hidden" id="panel-upload">
            <h3>Carregar Mapa</h3>
            <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ Abrir KMZ</button>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="display:none">
            <br><br>
            <button class="btn" style="background:#2980b9" onclick="addTestTree()">üå≤ Teste (Norte)</button>
        </div>
    </div>

    <!-- Cena AR -->
    <div id="scene-wrapper"></div>

    <script>
        const log = (msg) => document.getElementById('console-log').innerText = msg;
        
        // Estado Global
        let treeEntities = []; // {id, lat, lon, name, el, dist}
        let currentTarget = null; // √Årvore selecionada
        let userHeading = 0; // B√∫ssola do celular (0-360)
        let userLat = 0;
        let userLon = 0;

        // --- 1. Inicializa√ß√£o ---
        async function startApp() {
            try {
                // Hack permiss√£o v√≠deo Chrome
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());
                
                // Permiss√£o Orienta√ß√£o (Importante para iOS 13+)
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }

                if(!navigator.geolocation) throw new Error("Sem GPS");

                navigator.geolocation.getCurrentPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;
                    
                    injectScene();
                    
                    document.getElementById('panel-permission').classList.add('hidden');
                    document.getElementById('panel-upload').classList.remove('hidden');
                    
                    // Iniciar Loops
                    window.addEventListener('deviceorientation', handleOrientation);
                    setInterval(updateLoop, 1000); // Atualiza dist√¢ncias a cada 1s
                    setInterval(updateArrowUI, 100); // Atualiza seta suavemente
                    
                    log("GPS OK. Carregue o KMZ.");
                }, err => alert("Erro GPS: " + err.message));

            } catch(e) {
                alert("Erro: " + e.message);
            }
        }

        function injectScene() {
            const wrapper = document.getElementById('scene-wrapper');
            wrapper.innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" renderer="logarithmicDepthBuffer: true;">
                    <a-camera id="cam" gps-camera="minDistance: 5; maxDistance: 5000;" rotation-reader></a-camera>
                    <a-entity id="tree-container"></a-entity>
                </a-scene>
            `;
        }

        // --- 2. Manipula√ß√£o de Arquivo ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.toLowerCase().endsWith('.kml'));
                const kmlText = await content.files[kmlName].async("string");
                
                parseKML(kmlText);
                
                // UI Changes
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('menu-btn').style.display = 'block';
                toggleSidebar(); // Abre a lista automaticamente para mostrar que carregou
                
            } catch(err) {
                alert("Erro Arquivo: " + err.message);
            }
        });

        function parseKML(xml) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xml, "text/xml");
            const placemarks = xmlDoc.getElementsByTagName("Placemark");
            const container = document.getElementById('tree-container');
            
            treeEntities = []; // Limpa lista anterior
            container.innerHTML = ''; // Limpa cena
            
            let count = 0;
            for(let p of placemarks) {
                const coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                const name = p.getElementsByTagName("name")[0]?.textContent || "√Årvore " + (count+1);
                
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    
                    // Cria Elemento 3D
                    const el = document.createElement('a-entity');
                    el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
                    el.setAttribute('scale', '2 2 2');
                    el.innerHTML = `
                        <a-text value="${name}" align="center" color="yellow" position="0 4 0" look-at="[gps-camera]" scale="3 3 3"></a-text>
                        <a-cone color="#2ecc71" position="0 2 0" height="3"></a-cone>
                    `;
                    container.appendChild(el);

                    // Salva dados
                    treeEntities.push({
                        id: count,
                        name: name,
                        lat: lat,
                        lon: lon,
                        el: el,
                        dist: 99999 // Inicial
                    });
                    count++;
                }
            }
            
            document.getElementById('count-display').innerText = count;
            updateListUI();
        }

        // --- 3. L√≥gica de Lista e Navega√ß√£o ---
        
        function updateListUI() {
            const list = document.getElementById('tree-list');
            list.innerHTML = '';
            
            // Ordena por dist√¢ncia (Opcional, mas √∫til)
            const sortedTrees = [...treeEntities].sort((a, b) => a.dist - b.dist);

            sortedTrees.forEach(tree => {
                const li = document.createElement('li');
                li.className = 'list-item';
                if(currentTarget && currentTarget.id === tree.id) li.classList.add('selected');
                
                li.innerHTML = `<span>${tree.name}</span> <small>${tree.dist < 9999 ? tree.dist.toFixed(0) + 'm' : '...'}</small>`;
                li.onclick = () => selectTarget(tree.id);
                list.appendChild(li);
            });
        }

        function selectTarget(id) {
            // Encontra a √°rvore original pelo ID
            const tree = treeEntities.find(t => t.id === id);
            if(tree) {
                currentTarget = tree;
                document.getElementById('nav-hud').style.display = 'block';
                document.getElementById('target-name').innerText = tree.name;
                toggleSidebar(); // Fecha menu
                updateListUI(); // Atualiza destaque na lista
            }
        }

        function stopNavigation() {
            currentTarget = null;
            document.getElementById('nav-hud').style.display = 'none';
            updateListUI();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // --- 4. Loops de Atualiza√ß√£o ---

        // B√∫ssola do Celular
        function handleOrientation(event) {
            // alpha: rota√ß√£o em torno do eixo z (0 a 360 graus)
            // No Android, alpha 0 √© Norte. No iOS precisa de webkitCompassHeading
            if (event.webkitCompassHeading) {
                userHeading = event.webkitCompassHeading;
            } else {
                userHeading = event.alpha; 
            }
        }

        // Loop Lento (1s): GPS e Dist√¢ncias
        function updateLoop() {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                
                // Atualiza dist√¢ncias de todos
                treeEntities.forEach(tree => {
                    tree.dist = haversine(userLat, userLon, tree.lat, tree.lon);
                    // Mostra/Esconde na cena 3D se tiver perto (<1km)
                    tree.el.setAttribute('visible', tree.dist < 1000);
                });

                // Se o menu estiver aberto, atualiza os n√∫meros l√°
                if(document.getElementById('sidebar').classList.contains('open')) {
                    updateListUI();
                }

                // Atualiza texto da HUD
                if(currentTarget) {
                    const dist = currentTarget.dist;
                    document.getElementById('target-dist').innerText = dist.toFixed(0) + " metros";
                }
                
                log(`GPS: ${userLat.toFixed(5)} | Heading: ${Math.round(userHeading)}¬∞`);

            }, null, { enableHighAccuracy: true, maximumAge: 0 });
        }

        // Loop R√°pido (100ms): Seta Direcional
        function updateArrowUI() {
            if(!currentTarget) return;

            // 1. Calcula o √¢ngulo do Norte at√© o Destino (Bearing)
            const bearing = getBearing(userLat, userLon, currentTarget.lat, currentTarget.lon);
            
            // 2. Calcula a rota√ß√£o da seta: (Onde √© o destino) - (Onde estou olhando)
            // Ajuste: A seta aponta para cima (0deg), ent√£o rotacionamos ela.
            let arrowRot = bearing - userHeading;
            
            // Aplica rota√ß√£o CSS
            const dial = document.getElementById('arrow-dial');
            dial.style.transform = `rotate(${arrowRot}deg)`;
        }

        // --- Matem√°ticas ---

        function toRadians(degrees) { return degrees * Math.PI / 180; }
        function toDegrees(radians) { return radians * 180 / Math.PI; }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const œÜ1 = toRadians(lat1);
            const œÜ2 = toRadians(lat2);
            const ŒîœÜ = toRadians(lat2-lat1);
            const ŒîŒª = toRadians(lon2-lon1);

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            startLat = toRadians(startLat);
            startLng = toRadians(startLng);
            destLat = toRadians(destLat);
            destLng = toRadians(destLng);

            y = Math.sin(destLng - startLng) * Math.cos(destLat);
            x = Math.cos(startLat) * Math.sin(destLat) -
                Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
            brng = Math.atan2(y, x);
            return (toDegrees(brng) + 360) % 360;
        }
        
        // Teste
        function addTestTree() {
            // Adiciona √°rvore fake na lista
            const fakeTree = {
                id: 999,
                name: "√Årvore Teste",
                lat: userLat + 0.0005, // Norte
                lon: userLon,
                el: document.createElement('a-entity'),
                dist: 0
            };
            treeEntities.push(fakeTree);
            updateListUI();
            alert("√Årvore Teste adicionada na lista!");
            // Abre menu para user selecionar
            if(!document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }
    </script>
</body>
</html>
