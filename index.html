<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Locator - Campo 500m</title>

    <script>
        // Log de erros
        window.onerror = function(msg) {
            var logElem = document.getElementById('console-log');
            if (logElem) logElem.innerText = "‚ö†Ô∏è " + msg;
        };
    </script>

    <!-- A-Frame 1.3.0 + AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; }
        
        #console-log {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: #00ff00; font-size: 12px; 
            pointer-events: none; z-index: 9999; text-align: center; padding: 5px;
        }

        /* --- RADAR --- */
        #radar-container {
            position: fixed; top: 15px; right: 15px; width: 120px; height: 120px;
            background: rgba(0, 30, 0, 0.8); border: 2px solid #0f0; border-radius: 50%;
            z-index: 9990; display: none; overflow: hidden;
            box-shadow: 0 0 15px rgba(0,255,0,0.4);
        }
        #radar-center {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; 
            background: #fff; transform: translate(-50%, -50%); border-radius: 50%;
        }
        .radar-dot {
            position: absolute; width: 8px; height: 8px; background: yellow; 
            border-radius: 50%; transform: translate(-50%, -50%);
        }
        .radar-dot.target { 
            background: #ff0000; width: 12px; height: 12px; z-index: 10; 
            border: 2px solid #fff; box-shadow: 0 0 10px #ff0000;
        }

        /* --- HUD INFERIOR --- */
        #nav-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(10, 10, 10, 0.9); 
            padding: 15px; border-radius: 15px; border: 1px solid #555;
            text-align: center; color: white; z-index: 9995; display: none;
        }
        .big-dist { font-size: 40px; font-weight: 800; color: #fff; margin: 5px 0; }
        .btn-stop {
            background: #c0392b; color: white; border: none; padding: 10px 30px; 
            border-radius: 50px; font-weight: bold; font-size: 14px; cursor: pointer;
        }

        /* --- MENU LISTA --- */
        #menu-btn {
            position: fixed; top: 15px; left: 15px; z-index: 9995;
            background: white; border: none; padding: 10px 15px; border-radius: 8px; 
            font-size: 24px; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #sidebar {
            position: fixed; top: 0; left: -100%; width: 80%; height: 100%;
            background: #f4f4f4; z-index: 9996; transition: 0.3s; padding: 0; 
            overflow-y: auto; box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }
        #sidebar.open { left: 0; }
        .list-header {
            background: #fff; padding: 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item {
            padding: 20px; border-bottom: 1px solid #ddd; background: white; cursor: pointer;
        }
        .list-item:active { background: #e0e0e0; }
        .near-badge {
            background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;
        }
        .far-badge {
            background: #7f8c8d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;
        }

        /* --- TELA INICIAL --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222;
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .card { background: white; padding: 30px; border-radius: 10px; width: 80%; max-width: 350px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="console-log">Iniciando GPS...</div>

    <!-- Radar -->
    <div id="radar-container"><div id="radar-center"></div></div>

    <!-- Menu -->
    <button id="menu-btn" onclick="toggleSidebar()">üìÇ LISTA</button>
    <div id="sidebar">
        <div class="list-header">
            <h3 style="margin:0">Pontos Pr√≥ximos</h3>
            <button onclick="toggleSidebar()" style="font-size:20px; border:none; background:none;">‚úï</button>
        </div>
        <ul id="tree-list" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <!-- Painel de Navega√ß√£o -->
    <div id="nav-panel">
        <h3 id="hud-target" style="margin:0; color: #f1c40f;">Nome do Ponto</h3>
        <div id="hud-dist" class="big-dist">0m</div>
        <div style="color:#ccc; font-size:12px; margin-bottom:10px;">Siga a linha amarela</div>
        <button class="btn-stop" onclick="stopNav()">PARAR</button>
    </div>

    <!-- Tela Inicial -->
    <div id="start-screen">
        <div class="card" id="p1">
            <h2>Localizador de Campo</h2>
            <p>Raio de 500m + Linha Guia</p>
            <button onclick="initApp()" style="padding:15px; width:100%; background:#27ae60; color:white; border:none; font-size:16px; font-weight:bold; border-radius:5px;">INICIAR</button>
        </div>
        <div class="card hidden" id="p2">
            <h3>Carregar Dados</h3>
            <input type="file" id="fileInput" accept=".kmz,.kml" style="margin-bottom:15px;">
            <div style="font-size:12px; color:#666; margin:10px 0;">OU</div>
            <button onclick="createTestPoint()" style="padding:10px; width:100%; background:#3498db; color:white; border:none; border-radius:5px;">+ Criar Ponto Teste (10m)</button>
        </div>
    </div>

    <!-- CENA AR -->
    <div id="scene-wrapper"></div>

    <script>
        const log = txt => document.getElementById('console-log').innerText = txt;
        
        let points = [];
        let currentTarget = null;
        let userLat=0, userLon=0, userHeading=0;
        
        // Configura√ß√µes
        const VISIBILITY_RADIUS = 500; // S√≥ mostra o que estiver a 500m ou menos

        // 1. INICIAR SISTEMA
        async function initApp() {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    await DeviceOrientationEvent.requestPermission();
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream.getTracks().forEach(t => t.stop());

                navigator.geolocation.watchPosition(pos => {
                    userLat = pos.coords.latitude;
                    userLon = pos.coords.longitude;
                    
                    if(!document.querySelector('a-scene')) {
                        injectScene();
                        document.getElementById('p1').classList.add('hidden');
                        document.getElementById('p2').classList.remove('hidden');
                        startLoop();
                    }
                }, err => alert("Erro GPS: " + err.message), { enableHighAccuracy: true });

                window.addEventListener('deviceorientation', e => {
                    if(e.webkitCompassHeading) userHeading = e.webkitCompassHeading;
                    else if(e.alpha) userHeading = 360 - e.alpha;
                });

            } catch(e) { alert(e); }
        }

        function injectScene() {
            // maxDistance grande (2000) para o GPS detectar, mas n√≥s controlamos a visibilidade visualmente
            document.getElementById('scene-wrapper').innerHTML = `
                <a-scene embedded vr-mode-ui="enabled: false" 
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                    renderer="logarithmicDepthBuffer: true; antialias: true;">
                    
                    <a-camera id="cam" gps-camera="minDistance: 0; maxDistance: 2000;" rotation-reader>
                    </a-camera>

                    <!-- Container dos Pontos -->
                    <a-entity id="points-container"></a-entity>

                    <!-- LINHA GUIA (Corda) -->
                    <a-entity id="guide-line" visible="false" 
                        line="start: 0 -1 0; end: 0 -1 -5; color: yellow; opacity: 0.8"></a-entity>

                </a-scene>
            `;
            log("Sistema pronto. Carregue o KMZ.");
        }

        // 2. CARREGAMENTO
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file) return;
            
            let txt = "";
            if(file.name.toLowerCase().endsWith('.kmz')) {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                const kmlName = Object.keys(content.files).find(n => n.endsWith('.kml'));
                if(kmlName) txt = await content.files[kmlName].async("string");
            } else {
                txt = await file.text();
            }
            
            if(txt) parseKML(txt);
        });

        function parseKML(xml) {
            const doc = new DOMParser().parseFromString(xml, "text/xml");
            const container = document.getElementById('points-container');
            container.innerHTML = '';
            points = [];
            
            let count = 0;
            for(let p of doc.getElementsByTagName("Placemark")) {
                let coords = p.getElementsByTagName("coordinates")[0]?.textContent.trim();
                let name = p.getElementsByTagName("name")[0]?.textContent || `Ponto ${count}`;
                
                if(coords) {
                    const [lon, lat] = coords.split(',').map(parseFloat);
                    createPoint(lat, lon, name, count++);
                }
            }
            finishSetup();
        }

        function createTestPoint() {
            // Cria ponto 20 metros ao Norte
            createPoint(userLat + 0.0002, userLon, "TESTE DE CAMPO", 999);
            finishSetup();
        }

        function createPoint(lat, lon, name, id) {
            const el = document.createElement('a-entity');
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            
            // Modelo Visual: Uma "Placa" alta para ser vista de longe
            // position y=0 √© o n√≠vel da c√¢mera. Colocamos texto bem alto.
            el.innerHTML = `
                <a-entity class="marker-visual" position="0 0 0">
                    <!-- Texto Amarelo Brilhante -->
                    <a-text value="${name}\n---" align="center" color="#f1c40f" 
                        position="0 4 0" scale="15 15 15" look-at="[gps-camera]" side="double" font="roboto"></a-text>
                    
                    <!-- Pino Vermelho -->
                    <a-cylinder color="red" height="4" radius="0.2" position="0 2 0"></a-cylinder>
                    <a-sphere color="red" radius="0.8" position="0 4 0"></a-sphere>
                    
                    <!-- Base (Alvo) -->
                    <a-ring color="white" radius-inner="1" radius-outer="1.5" rotation="-90 0 0" position="0 0.1 0"></a-ring>
                </a-entity>
            `;
            
            document.getElementById('points-container').appendChild(el);
            
            // Radar Dot
            const dot = document.createElement('div');
            dot.className = 'radar-dot';
            document.getElementById('radar-container').appendChild(dot);
            
            points.push({ id, name, lat, lon, el, dist: 99999, dot });
        }

        function finishSetup() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('menu-btn').style.display = 'block';
            document.getElementById('radar-container').style.display = 'block';
            updateCalculations();
        }

        // 3. L√ìGICA PRINCIPAL
        function startLoop() {
            setInterval(updateCalculations, 1000); // Dist√¢ncia (1s)
            setInterval(updateVisuals, 50);       // Radar e Linha (r√°pido)
        }

        function updateCalculations() {
            if(!userLat) return;

            const list = document.getElementById('tree-list');
            list.innerHTML = '';

            // Ordena por dist√¢ncia
            points.forEach(p => p.dist = haversine(userLat, userLon, p.lat, p.lon));
            points.sort((a, b) => a.dist - b.dist);

            points.forEach(p => {
                // 1. Escala Din√¢mica: Quanto mais longe, maior o objeto para ser vis√≠vel
                const model = p.el.querySelector('.marker-visual');
                if(model) {
                    // Se < 20m, escala 1. Se 500m, escala 30.
                    let scaleFactor = Math.max(1, p.dist / 15); 
                    model.setAttribute('scale', `${scaleFactor} ${scaleFactor} ${scaleFactor}`);
                }
                
                // 2. Atualiza Texto Dist√¢ncia
                const txt = p.el.querySelector('a-text');
                if(txt) txt.setAttribute('value', `${p.name}\n${Math.round(p.dist)}m`);

                // 3. Visibilidade (Filtro 500m)
                const isVisible = p.dist <= VISIBILITY_RADIUS;
                p.el.setAttribute('visible', isVisible);

                // 4. Adiciona na lista se < 500m
                if(isVisible) {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    const badge = p.dist < 50 ? '<span class="near-badge">PERTO</span>' : '<span class="far-badge">LONGE</span>';
                    li.innerHTML = `<b>${p.name}</b><br><small>${Math.round(p.dist)}m ${badge}</small>`;
                    li.onclick = () => setTarget(p.id);
                    list.appendChild(li);
                }
            });

            if(currentTarget) {
                document.getElementById('hud-dist').innerText = Math.round(currentTarget.dist) + "m";
            }
        }

        function updateVisuals() {
            if(!userLat) return;

            // Atualiza Radar
            points.forEach(p => {
                if(p.dist > VISIBILITY_RADIUS) {
                    p.dot.style.display = 'none';
                    return;
                }
                p.dot.style.display = 'block';

                const bearing = getBearing(userLat, userLon, p.lat, p.lon);
                let angle = bearing - userHeading;
                // Normalizar -180 a 180
                while(angle < -180) angle += 360;
                while(angle > 180) angle -= 360;

                // Radar UI
                const r = 40; // Raio fixo no radar
                const rad = angle * (Math.PI / 180);
                const x = 50 + (r * Math.sin(rad));
                const y = 50 - (r * Math.cos(rad));
                
                p.dot.style.left = x + '%';
                p.dot.style.top = y + '%';
            });

            // LINHA GUIA (A Corda)
            const lineEl = document.getElementById('guide-line');
            if(currentTarget && currentTarget.el.object3D.visible) {
                // Pega a posi√ß√£o do objeto alvo em rela√ß√£o √† c√¢mera (mundo 3D local)
                const pos = currentTarget.el.getAttribute('position');
                
                // Se o objeto j√° foi posicionado pelo AR.js
                if(pos) {
                    lineEl.setAttribute('visible', 'true');
                    // Come√ßa um pouco abaixo da tela (-1) e vai at√© o objeto
                    // Usamos setAttribute para for√ßar atualiza√ß√£o visual da linha
                    lineEl.setAttribute('line', {
                        start: {x: 0, y: -1, z: 0},
                        end: {x: pos.x, y: pos.y, z: pos.z},
                        color: 'yellow',
                        opacity: 0.8
                    });
                }
            } else {
                lineEl.setAttribute('visible', 'false');
            }
        }

        // 4. CONTROLES
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function setTarget(id) {
            // Reset antigo
            if(currentTarget) currentTarget.dot.classList.remove('target');
            
            currentTarget = points.find(p => p.id === id);
            currentTarget.dot.classList.add('target');
            
            document.getElementById('nav-panel').style.display = 'block';
            document.getElementById('hud-target').innerText = currentTarget.name;
            toggleSidebar(); // Fecha menu
        }

        function stopNav() {
            if(currentTarget) currentTarget.dot.classList.remove('target');
            currentTarget = null;
            document.getElementById('nav-panel').style.display = 'none';
            document.getElementById('guide-line').setAttribute('visible', 'false');
        }

        // 5. MATEM√ÅTICA
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(destLng*Math.PI/180 - startLng*Math.PI/180) * Math.cos(destLat*Math.PI/180);
            const x = Math.cos(startLat*Math.PI/180)*Math.sin(destLat*Math.PI/180) - Math.sin(startLat*Math.PI/180)*Math.cos(destLat*Math.PI/180)*Math.cos(destLng*Math.PI/180 - startLng*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }

    </script>
</body>
</html>
